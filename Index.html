<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARENA ADMIN | CENTER CONTROL</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/th.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@200;300;400;500;600&family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --primary: #D4AF37;
            --primary-hover: #b59021;
            --bg-dark: #0f172a;
            --sidebar: #020617;
            --card: #1e293b;
            --text-main: #f1f5f9;
            --text-mute: #94a3b8;
        }

        body { font-family: 'Prompt', sans-serif; background: var(--bg-dark); color: var(--text-main); overflow: hidden; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* Sidebar Styles */
        .sidebar { width: 280px; height: 100vh; background: var(--sidebar); border-right: 1px solid #1e293b; position: fixed; display: flex; flex-direction: column; transition: 0.3s; z-index: 50; }
        .main-content { margin-left: 280px; height: 100vh; overflow-y: auto; padding: 2rem; background: radial-gradient(circle at 50% 0%, #1e293b 0%, #0f172a 100%); }

        /* Nav Items */
        .nav-item { padding: 14px 20px; margin: 4px 12px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: var(--text-mute); transition: all 0.2s ease; font-weight: 300; }
        .nav-item:hover { background: rgba(255, 255, 255, 0.05); color: #fff; transform: translateX(5px); }
        .nav-item.active { background: linear-gradient(90deg, rgba(212, 175, 55, 0.15) 0%, transparent 100%); color: var(--primary); border-left: 3px solid var(--primary); font-weight: 500; }
        .nav-item i { width: 24px; text-align: center; font-size: 1.1rem; }

        /* Cards & Inputs */
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 16px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3); }
        .input-dark { background: #020617; border: 1px solid #334155; color: white; padding: 12px 16px; border-radius: 10px; width: 100%; transition: 0.3s; outline: none; }
        .input-dark:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2); }
        
        /* Buttons */
        .btn-gold { background: linear-gradient(to right, #D4AF37, #AA8A26); color: #000; border: none; padding: 10px 24px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3); }
        .btn-gold:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .btn-gold:active { transform: scale(0.98); }

        .btn-icon { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: 0.2s; cursor: pointer; }
        .btn-icon:hover { background: rgba(255,255,255,0.1); }

        /* Status Badges */
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-pending { background: rgba(234, 179, 8, 0.15); color: #facc15; border: 1px solid rgba(234, 179, 8, 0.3); }
        .status-success { background: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3); }
        .status-reject { background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }

        /* Animations */
        .new-tx-glow { animation: glow 2s infinite; border-left: 4px solid var(--primary); }
        @keyframes glow { 0% { box-shadow: 0 0 5px rgba(212, 175, 55, 0.5); } 50% { box-shadow: 0 0 20px rgba(212, 175, 55, 0.2); } 100% { box-shadow: 0 0 5px rgba(212, 175, 55, 0.5); } }
        
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Loader */
        .loader-overlay { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .spinner { width: 50px; height: 50px; border: 4px solid #1e293b; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="page-loader" class="loader-overlay">
        <div class="spinner"></div>
        <p class="mt-4 text-[#D4AF37] tracking-[0.2em] text-xs font-bold animate-pulse">CONNECTING SERVER...</p>
    </div>

    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-[#020617] bg-opacity-95 backdrop-blur-sm hidden">
        <div class="glass-card w-full max-w-sm p-8 text-center border-t-4 border-[#D4AF37] animate__animated animate__fadeInDown">
            <div class="mb-6">
                <div class="w-16 h-16 bg-gradient-to-tr from-[#D4AF37] to-[#000] rounded-2xl mx-auto flex items-center justify-center text-2xl font-bold text-white shadow-lg mb-4">A</div>
                <h1 class="text-3xl font-bold text-white">ADMIN PANEL</h1>
                <p class="text-xs text-gray-500 tracking-[0.3em] uppercase mt-1">Authorized Access Only</p>
            </div>
            
            <div class="space-y-4 text-left">
                <div>
                    <label class="text-xs text-gray-400 ml-1">Email Access</label>
                    <input id="login-email" class="input-dark text-center font-bold text-[#D4AF37]" value="farisxuma1@gmail.com" readonly>
                </div>
                <div>
                    <label class="text-xs text-gray-400 ml-1">Secure Password</label>
                    <input type="password" id="login-pass" class="input-dark text-center" placeholder="••••••••">
                </div>
                <button onclick="App.login()" class="btn-gold w-full mt-4 py-3 text-lg shadow-lg">LOGIN SYSTEM</button>
            </div>
            <p class="mt-6 text-[10px] text-gray-600">IP: <span id="user-ip">Loading...</span> | Secure Connection</p>
        </div>
    </div>

    <div id="main-app" class="hidden">
        
        <aside class="sidebar">
            <div class="p-6 border-b border-[#1e293b] flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-[#D4AF37] to-[#8a6d1c] flex items-center justify-center text-black font-bold text-xl shadow-lg shadow-[#D4AF37]/20">A</div>
                <div>
                    <h2 class="font-bold text-white text-lg tracking-wide">ARENA</h2>
                    <p class="text-[9px] text-[#D4AF37] tracking-[0.2em] font-bold">SUPER ADMIN</p>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto py-4 px-2 space-y-1">
                <p class="px-4 text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-2">Main Menu</p>
                <div onclick="Router.go('dash')" id="nav-dash" class="nav-item active"><i class="fa-solid fa-chart-pie"></i> แดชบอร์ด</div>
                <div onclick="Router.go('finance')" id="nav-finance" class="nav-item">
                    <i class="fa-solid fa-money-bill-transfer"></i> รายการฝาก-ถอน
                    <span id="badge-count" class="ml-auto bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full hidden animate-bounce shadow-lg shadow-red-500/50">0</span>
                </div>
                <div onclick="Router.go('users')" id="nav-users" class="nav-item"><i class="fa-solid fa-users"></i> จัดการสมาชิก</div>
                
                <p class="px-4 text-[10px] font-bold text-gray-500 uppercase tracking-wider mt-6 mb-2">System Config</p>
                <div onclick="Router.go('banks')" id="nav-banks" class="nav-item"><i class="fa-solid fa-building-columns"></i> ธนาคารเว็บ</div>
                <div onclick="Router.go('promos')" id="nav-promos" class="nav-item"><i class="fa-solid fa-tags"></i> โปรโมชั่น</div>
                <div onclick="Router.go('settings')" id="nav-settings" class="nav-item"><i class="fa-solid fa-sliders"></i> ตั้งค่าเว็บไซต์</div>
            </div>

            <div class="p-4 border-t border-[#1e293b]">
                <button onclick="App.logout()" class="w-full bg-[#1e293b] text-red-400 py-3 rounded-xl text-xs font-bold border border-red-900/30 hover:bg-red-900/20 hover:border-red-500 transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-power-off"></i> ออกจากระบบ
                </button>
            </div>
        </aside>

        <main class="main-content">
            
            <header class="flex justify-between items-center mb-8 bg-[#1e293b]/50 p-4 rounded-2xl border border-[#334155] backdrop-blur-md sticky top-4 z-40">
                <div>
                    <h2 id="page-title" class="text-xl font-bold text-white uppercase tracking-wide">Dashboard</h2>
                    <p class="text-xs text-gray-400 mt-0.5" id="current-date">...</p>
                </div>
                <div class="flex items-center gap-4">
                    <div id="db-status" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-900/20 border border-green-500/30">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                        <span class="text-xs font-bold text-green-500">SYSTEM ONLINE</span>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-[#D4AF37] to-[#000] p-0.5">
                        <div class="w-full h-full bg-[#0f172a] rounded-full flex items-center justify-center text-[#D4AF37] font-bold">A</div>
                    </div>
                </div>
            </header>

            <section id="p-dash" class="fade-in">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="glass-card p-6 border-l-4 border-blue-500 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="fa-solid fa-users text-6xl text-blue-500"></i></div>
                        <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">สมาชิกทั้งหมด</p>
                        <h3 class="text-4xl font-bold text-white mt-2" id="st-users">0</h3>
                        <p class="text-[10px] text-blue-400 mt-2 flex items-center gap-1"><i class="fa-solid fa-arrow-up"></i> Realtime Update</p>
                    </div>
                    <div class="glass-card p-6 border-l-4 border-[#D4AF37] relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="fa-solid fa-coins text-6xl text-[#D4AF37]"></i></div>
                        <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">ยอดฝากรวม (Approved)</p>
                        <h3 class="text-4xl font-bold text-[#D4AF37] mt-2" id="st-dep">฿0</h3>
                        <p class="text-[10px] text-[#D4AF37] mt-2 flex items-center gap-1"><i class="fa-solid fa-wallet"></i> Total Deposit</p>
                    </div>
                    <div class="glass-card p-6 border-l-4 border-red-500 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="fa-solid fa-clock text-6xl text-red-500"></i></div>
                        <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">รออนุมัติ (Pending)</p>
                        <h3 class="text-4xl font-bold text-red-500 mt-2" id="st-pen">0</h3>
                        <p class="text-[10px] text-red-400 mt-2 flex items-center gap-1"><i class="fa-solid fa-bell"></i> Action Needed</p>
                    </div>
                </div>
                <div class="glass-card p-6 h-[400px]">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-white">สถิติการฝากเงิน (7 วันล่าสุด)</h3>
                        <button class="text-xs text-gray-400 hover:text-white"><i class="fa-solid fa-arrows-rotate"></i> Refresh</button>
                    </div>
                    <div class="relative h-full w-full">
                        <canvas id="financeChart"></canvas>
                    </div>
                </div>
            </section>

            <section id="p-finance" class="hidden fade-in">
                <div class="mb-8">
                    <h3 class="text-[#D4AF37] font-bold text-lg mb-4 flex items-center gap-2 border-b border-[#334155] pb-2">
                        <span class="w-2 h-6 bg-[#D4AF37] rounded-sm"></span>
                        รายการรอตรวจสอบ <span class="text-xs text-gray-500 font-normal">(Pending Requests)</span>
                    </h3>
                    <div id="list-pending" class="grid gap-4">
                        <div class="text-center py-12 border-2 border-dashed border-[#334155] rounded-2xl text-gray-500">
                            <i class="fa-solid fa-check-circle text-4xl mb-2 opacity-50"></i>
                            <p>ไม่มีรายการค้างในขณะนี้</p>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-gray-400 font-bold text-sm mb-4 uppercase tracking-wider">ประวัติย้อนหลัง (50 รายการล่าสุด)</h3>
                    <div class="glass-card p-0 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-gray-400">
                                <thead class="bg-[#0f172a] text-xs uppercase font-bold text-gray-500">
                                    <tr>
                                        <th class="p-4">เวลา</th>
                                        <th>ประเภท</th>
                                        <th>ผู้ใช้</th>
                                        <th>จำนวนเงิน</th>
                                        <th>สถานะ</th>
                                    </tr>
                                </thead>
                                <tbody id="tb-tx-hist" class="divide-y divide-[#334155]"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="p-users" class="hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <div class="relative">
                        <i class="fa-solid fa-search absolute left-4 top-3.5 text-gray-500"></i>
                        <input onkeyup="UI.filterTable('tb-users', this.value)" class="input-dark pl-10 w-72" placeholder="ค้นหาชื่อ, เบอร์โทร...">
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-400">สมาชิกทั้งหมด</p>
                        <p class="text-2xl font-bold text-white" id="users-count-badge">0</p>
                    </div>
                </div>
                <div class="glass-card p-0 overflow-hidden">
                    <table class="w-full text-left text-sm text-gray-400">
                        <thead class="bg-[#0f172a] text-xs uppercase font-bold text-gray-500">
                            <tr>
                                <th class="p-4 pl-6">ข้อมูลส่วนตัว</th>
                                <th>ธนาคาร</th>
                                <th>เครดิตคงเหลือ</th>
                                <th>ช่องทางติดต่อ</th>
                                <th class="text-right pr-6">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="tb-users" class="divide-y divide-[#334155]"></tbody>
                    </table>
                </div>
            </section>

            <section id="p-banks" class="hidden fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1">
                        <div class="glass-card p-6 sticky top-24">
                            <h3 class="font-bold text-white mb-4 border-b border-[#334155] pb-2">เพิ่มบัญชีธนาคาร</h3>
                            <div class="space-y-4">
                                <div><label class="text-xs text-gray-500">ชื่อธนาคาร</label><input id="bnk-name" class="input-dark mt-1" placeholder="เช่น KBANK, SCB"></div>
                                <div><label class="text-xs text-gray-500">เลขบัญชี</label><input id="bnk-acc" class="input-dark mt-1" placeholder="xxx-x-xxxxx-x"></div>
                                <div><label class="text-xs text-gray-500">ชื่อเจ้าของบัญชี</label><input id="bnk-own" class="input-dark mt-1" placeholder="ชื่อ-นามสกุล"></div>
                                <button onclick="Admin.addBank()" class="btn-gold w-full mt-2">บันทึกข้อมูล</button>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <h3 class="font-bold text-white mb-4">บัญชีที่แสดงหน้าเว็บ (ลูกค้า)</h3>
                        <div id="bank-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </div>
                </div>
            </section>

            <section id="p-promos" class="hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-white">จัดการโปรโมชั่น</h3>
                    <button onclick="Admin.addPromo()" class="btn-gold text-xs px-4 py-2"><i class="fa-solid fa-plus mr-1"></i> เพิ่มโปรโมชั่น</button>
                </div>
                <div id="list-promos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>

            <section id="p-settings" class="hidden fade-in">
                <div class="max-w-2xl mx-auto glass-card p-8">
                    <h3 class="text-xl font-bold text-white mb-6 border-b border-[#334155] pb-4 flex items-center gap-2">
                        <i class="fa-solid fa-sliders text-[#D4AF37]"></i> ตั้งค่าระบบทั่วไป
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div><label class="text-xs text-gray-500 font-bold ml-1">ชื่อเว็บไซต์ (Title)</label><input id="set-name" class="input-dark mt-1"></div>
                        <div><label class="text-xs text-gray-500 font-bold ml-1">ยอดถอนขั้นต่ำ (บาท)</label><input id="set-min" type="number" class="input-dark mt-1"></div>
                    </div>

                    <div class="space-y-4 mb-8">
                        <div><label class="text-xs text-gray-500 font-bold ml-1">ข้อความประกาศ (Marquee)</label><textarea id="set-ann" class="input-dark mt-1 h-20 resize-none"></textarea></div>
                        <div><label class="text-xs text-gray-500 font-bold ml-1">ลิงก์ติดต่อ (Line OA / Facebook)</label><input id="set-link" class="input-dark mt-1" placeholder="https://line.me/..."></div>
                    </div>

                    <div class="bg-[#0f172a] p-4 rounded-xl border border-[#334155] mb-6">
                        <p class="text-xs text-gray-400 font-bold mb-3 uppercase">สถานะระบบ (System Status)</p>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-white">ระบบฝากเงิน</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="set-dep" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-white">ระบบถอนเงิน</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="set-wit" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                            </label>
                        </div>
                    </div>

                    <button onclick="Admin.saveSet()" class="btn-gold w-full py-3 text-lg shadow-lg">บันทึกการเปลี่ยนแปลง</button>
                </div>
            </section>

        </main>
    </div>

    <script>
        // --- ⚠️ CONFIGURATION ⚠️ (เปลี่ยนให้ตรงกับเว็บลูกค้า) ---
        const firebaseConfig = { apiKey: "AIzaSyAochx_FIKbXLrbhhcLdVrpaurjjk4aQYc", authDomain: "paoshuv-c260d.firebaseapp.com", databaseURL: "https://paoshuv-c260d-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "paoshuv-c260d" };
        
        // INIT
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const ADMIN_MAIL = "farisxuma1@gmail.com";

        // IP & DATE
        fetch('https://api.ipify.org?format=json').then(r=>r.json()).then(d=>document.getElementById('user-ip').innerText=d.ip);
        setInterval(()=>document.getElementById('current-date').innerText=moment().locale('th').format('LLLL'), 1000);

        // CONNECTION CHECK
        db.ref(".info/connected").on("value", s => {
            const el = document.getElementById('db-status');
            const loader = document.getElementById('page-loader');
            if(s.val()===true) {
                el.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> <span class="text-xs font-bold text-green-500">SYSTEM ONLINE</span>';
                el.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-900/20 border border-green-500/30';
                setTimeout(()=> loader.style.opacity='0', 500);
                setTimeout(()=> loader.style.display='none', 1000);
            } else {
                el.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span> <span class="text-xs font-bold text-red-500">DISCONNECTED</span>';
                el.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-900/20 border border-red-500/30';
            }
        });

        // AUTH CHECK
        auth.onAuthStateChanged(u => {
            if(u && u.email === ADMIN_MAIL) {
                document.getElementById('auth-screen').style.display='none';
                document.getElementById('main-app').classList.remove('hidden');
                Admin.init();
            } else {
                document.getElementById('auth-screen').style.display='flex';
                document.getElementById('main-app').classList.add('hidden');
            }
        });

        const Auth = {
            login: () => {
                const e = document.getElementById('login-email').value, p = document.getElementById('login-pass').value;
                if(!p) return Swal.fire('Error','กรุณาระบุรหัสผ่าน','warning');
                auth.signInWithEmailAndPassword(e,p).catch(err=>{
                    if(err.code === 'auth/user-not-found') auth.createUserWithEmailAndPassword(e,p).then(()=>location.reload());
                    else Swal.fire('Login Failed', err.message, 'error');
                });
            },
            logout: () => auth.signOut().then(()=>location.reload())
        };

        const Admin = {
            init: () => {
                // Chart Init
                new Chart(document.getElementById('financeChart').getContext('2d'), {
                    type: 'line',
                    data: { labels: ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'], datasets: [{ label: 'Deposit', data: [0,0,0,0,0,0,0], borderColor: '#D4AF37', backgroundColor: 'rgba(212,175,55,0.1)', fill: true, tension: 0.4 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#334155' } }, x: { grid: { color: '#334155' } } } }
                });

                // 1. Transactions Logic (Realtime Sync Fix)
                db.ref('transactions').limitToLast(100).on('value', s => {
                    const pl = document.getElementById('list-pending'); pl.innerHTML = '';
                    const hl = document.getElementById('tb-tx-hist'); hl.innerHTML = '';
                    let depSum = 0, pendingCount = 0;
                    const arr = [];

                    if(s.exists()) s.forEach(d => arr.unshift({key: d.key, ...d.val()}));

                    if(arr.length === 0) pl.innerHTML = '<div class="text-center py-10 border-2 border-dashed border-[#334155] rounded-2xl text-gray-500">ไม่มีรายการค้าง</div>';

                    arr.forEach(t => {
                        // Stats Calculation
                        if(t.type === 'deposit' && t.status === 'approved') depSum += Number(t.amount);

                        // Pending List (Card UI)
                        if(t.status === 'pending') {
                            pendingCount++;
                            const isDep = t.type === 'deposit';
                            const badgeColor = isDep ? 'bg-green-500' : 'bg-red-500';
                            const borderColor = isDep ? 'border-green-500' : 'border-red-500';
                            
                            pl.innerHTML += `
                                <div class="glass-card p-5 border-l-4 ${borderColor} flex flex-col md:flex-row justify-between items-center gap-4 new-tx-glow">
                                    <div class="flex items-center gap-4 w-full">
                                        <div class="w-12 h-12 rounded-xl flex items-center justify-center text-white text-2xl font-bold ${badgeColor} shadow-lg shadow-${isDep?'green':'red'}-500/20">
                                            <i class="fa-solid ${isDep?'fa-arrow-down':'fa-arrow-up'}"></i>
                                        </div>
                                        <div>
                                            <div class="flex items-center gap-2">
                                                <span class="text-xl font-bold text-white">${isDep?'ฝากเงิน':'ถอนเงิน'}</span>
                                                <span class="text-xl font-mono text-[#D4AF37]">฿${Number(t.amount).toLocaleString()}</span>
                                                ${t.bonus ? `<span class="text-xs bg-green-900/50 text-green-400 px-2 py-0.5 rounded border border-green-500/30">+${t.bonus}</span>` : ''}
                                            </div>
                                            <div class="text-sm text-gray-400 mt-1 flex items-center gap-2">
                                                <i class="fa-solid fa-user"></i> ${t.name}
                                                <span class="text-gray-600">•</span>
                                                <i class="fa-regular fa-clock"></i> ${moment(t.timestamp).fromNow()}
                                            </div>
                                            <div class="text-xs text-[#D4AF37] mt-1 bg-black/20 px-2 py-1 rounded inline-block border border-[#D4AF37]/20">
                                                ${t.time || t.bank_info} ${t.promo ? `(PRO: ${t.promo})` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2 w-full md:w-auto">
                                        <button onclick="Admin.tx('${t.key}','app','${t.uid}',${t.total||t.amount},'${t.type}',${t.amount})" class="flex-1 md:w-auto bg-green-600 hover:bg-green-500 text-white px-6 py-3 rounded-xl text-sm font-bold shadow-lg transition flex items-center justify-center gap-2">
                                            <i class="fa-solid fa-check"></i> อนุมัติ
                                        </button>
                                        <button onclick="Admin.tx('${t.key}','rej','${t.uid}',${t.amount},'${t.type}',${t.amount})" class="flex-1 md:w-auto bg-red-600 hover:bg-red-500 text-white px-6 py-3 rounded-xl text-sm font-bold shadow-lg transition flex items-center justify-center gap-2">
                                            <i class="fa-solid fa-xmark"></i> ปฏิเสธ
                                        </button>
                                    </div>
                                </div>`;
                        } else {
                            // History Table
                            let statusClass = t.status=='approved' ? 'status-success' : 'status-reject';
                            hl.innerHTML += `
                                <tr class="border-b border-[#334155] hover:bg-[#1e293b] transition">
                                    <td class="p-4 pl-6 text-gray-300 font-mono text-xs">${moment(t.timestamp).format('DD/MM/YY HH:mm')}</td>
                                    <td><span class="badge ${t.type=='deposit'?'bg-green-900/30 text-green-400':'bg-red-900/30 text-red-400'} border border-opacity-20">${t.type.toUpperCase()}</span></td>
                                    <td class="text-sm text-white">${t.name}</td>
                                    <td class="font-bold text-[#D4AF37] font-mono">฿${Number(t.amount).toLocaleString()}</td>
                                    <td><span class="status-badge ${statusClass}">${t.status}</span></td>
                                </tr>`;
                        }
                    });

                    // Update Dashboard Stats
                    document.getElementById('st-dep').innerText = `฿${depSum.toLocaleString()}`;
                    document.getElementById('st-pen').innerText = pendingCount;
                    const badge = document.getElementById('badge-count');
                    if(pendingCount > 0) {
                        badge.innerText = pendingCount;
                        badge.classList.remove('hidden');
                        document.title = `(${pendingCount}) ADMIN PANEL`; // Tab Notification
                    } else {
                        badge.classList.add('hidden');
                        document.title = 'ADMIN PANEL';
                    }
                });

                // 2. Manage Banks (Multi-Account)
                db.ref('admin_banks').on('value', s => {
                    const l = document.getElementById('bank-list'); l.innerHTML = '';
                    if(!s.exists()) l.innerHTML = '<p class="text-gray-500 col-span-2 text-center py-4">ยังไม่มีบัญชีธนาคาร</p>';
                    s.forEach(d => {
                        const b = d.val();
                        l.innerHTML += `
                            <div class="glass-card p-4 flex justify-between items-center group hover:border-[#D4AF37] transition">
                                <div>
                                    <p class="text-sm font-bold text-white">${b.bankName}</p>
                                    <p class="text-lg font-mono text-[#D4AF37] font-bold tracking-wider">${b.accNo}</p>
                                    <p class="text-xs text-gray-500">${b.accName}</p>
                                </div>
                                <button onclick="db.ref('admin_banks/${d.key}').remove()" class="w-8 h-8 bg-red-900/20 text-red-500 rounded-lg flex items-center justify-center hover:bg-red-500 hover:text-white transition"><i class="fa-solid fa-trash"></i></button>
                            </div>`;
                    });
                });

                // 3. Users & Contact
                db.ref('users').on('value', s => {
                    const l = document.getElementById('tb-users'); l.innerHTML = '';
                    document.getElementById('st-users').innerText = s.numChildren();
                    document.getElementById('users-count-badge').innerText = s.numChildren();
                    
                    s.forEach(d => {
                        const u = d.val(); const k = d.key;
                        const contactBtn = u.fb_link ? 
                            `<button onclick="window.open('${u.fb_link}')" class="bg-blue-600/20 text-blue-400 border border-blue-600/30 px-3 py-1 rounded-lg text-xs hover:bg-blue-600 hover:text-white transition flex items-center gap-1"><i class="fa-brands fa-line"></i> ติดต่อ</button>` : 
                            `<span class="text-gray-600 text-xs">-</span>`;
                        
                        l.innerHTML += `
                            <tr class="border-b border-[#334155] hover:bg-[#1e293b] transition group">
                                <td class="p-4 pl-6">
                                    <div class="font-bold text-white">${u.name}</div>
                                    <div class="text-xs text-gray-500 font-mono">${u.email}</div>
                                </td>
                                <td>
                                    <div class="text-xs text-gray-400">${u.bank}</div>
                                    <div class="text-xs text-[#D4AF37] font-mono">${u.acc}</div>
                                </td>
                                <td class="font-bold text-white font-mono text-lg">฿${(u.balance||0).toLocaleString()}</td>
                                <td>${contactBtn}</td>
                                <td class="text-right pr-6">
                                    <button onclick="Admin.adj('${k}','${u.name}',${u.balance})" class="bg-[#0f172a] text-gray-300 px-3 py-1.5 rounded-lg border border-[#334155] hover:border-[#D4AF37] hover:text-[#D4AF37] text-xs transition">
                                        <i class="fa-solid fa-pen"></i> ปรับเงิน
                                    </button>
                                </td>
                            </tr>`;
                    });
                });

                // 4. Settings & Promos
                db.ref('settings').on('value', s => {
                    const c = s.val() || {};
                    document.getElementById('set-name').value = c.siteName||'';
                    document.getElementById('set-ann').value = c.announcement||'';
                    document.getElementById('set-link').value = c.contactLink||'';
                    document.getElementById('set-min').value = c.minWithdraw||100;
                    document.getElementById('set-dep').checked = c.isDepositActive!==false;
                    document.getElementById('set-wit').checked = c.isWithdrawActive!==false;
                });

                db.ref('promotions').on('value', s => {
                    const l = document.getElementById('list-promos'); l.innerHTML = '';
                    s.forEach(d => {
                        const p = d.val();
                        l.innerHTML += `
                            <div class="glass-card p-4 relative group hover:border-[#D4AF37] transition">
                                <button onclick="db.ref('promotions/${d.key}').remove()" class="absolute top-2 right-2 text-red-500 bg-black/50 w-6 h-6 rounded flex items-center justify-center hover:bg-red-500 hover:text-white transition"><i class="fa-solid fa-times"></i></button>
                                <div class="flex items-center gap-3">
                                    <img src="${p.img}" class="w-12 h-12 rounded-lg bg-black object-cover">
                                    <div>
                                        <h4 class="font-bold text-[#D4AF37] text-sm">${p.title}</h4>
                                        <p class="text-[10px] text-gray-400">ฝาก ${p.minDep} รับ ${p.bonus}%</p>
                                    </div>
                                </div>
                            </div>`;
                    });
                });
            },

            // --- SYSTEM ACTIONS (CORE LOGIC) ---
            tx: (key, action, uid, totalAmt, type, rawAmt) => {
                if(action === 'app') {
                    // APPROVE
                    db.ref('transactions/'+key).update({status: 'approved'});
                    if(type === 'deposit') {
                        // Deposit: Update Balance
                        db.ref('users/'+uid).once('value', s => {
                            const cur = s.val().balance || 0;
                            db.ref('users/'+uid).update({balance: cur + Number(totalAmt)});
                        });
                    }
                    // Withdraw: Balance deducted on request, no action needed on approve.
                    Swal.fire({icon:'success', title:'อนุมัติเรียบร้อย', timer:1000, showConfirmButton:false, background:'#1e293b', color:'#fff'});
                } else {
                    // REJECT
                    db.ref('transactions/'+key).update({status: 'rejected'});
                    if(type === 'withdraw') {
                        // Withdraw Reject: REFUND BALANCE (Important!)
                        db.ref('users/'+uid).once('value', s => {
                            const cur = s.val().balance || 0;
                            db.ref('users/'+uid).update({balance: cur + Number(rawAmt)});
                        });
                        Swal.fire({icon:'info', title:'คืนเงินลูกค้าแล้ว', text:'เนื่องจากปฏิเสธการถอน', timer:1500, showConfirmButton:false, background:'#1e293b', color:'#fff'});
                    } else {
                        Swal.fire({icon:'info', title:'ปฏิเสธรายการ', timer:1000, showConfirmButton:false, background:'#1e293b', color:'#fff'});
                    }
                }
            },
            addBank: () => {
                const n = document.getElementById('bnk-name').value;
                const a = document.getElementById('bnk-acc').value;
                const o = document.getElementById('bnk-own').value;
                if(n && a) {
                    db.ref('admin_banks').push({bankName:n, accNo:a, accName:o})
                        .then(() => {
                            Swal.fire({icon:'success', title:'เพิ่มบัญชีแล้ว', timer:1000, showConfirmButton:false, background:'#1e293b', color:'#fff'});
                            document.getElementById('bnk-acc').value = '';
                        });
                } else {
                    Swal.fire({icon:'warning', title:'ข้อมูลไม่ครบ', background:'#1e293b', color:'#fff'});
                }
            },
            saveSet: () => {
                db.ref('settings').update({
                    siteName: document.getElementById('set-name').value,
                    announcement: document.getElementById('set-ann').value,
                    contactLink: document.getElementById('set-link').value,
                    minWithdraw: Number(document.getElementById('set-min').value),
                    isDepositActive: document.getElementById('set-dep').checked,
                    isWithdrawActive: document.getElementById('set-wit').checked
                }).then(() => Swal.fire({icon:'success', title:'บันทึกการตั้งค่าแล้ว', timer:1000, showConfirmButton:false, background:'#1e293b', color:'#fff'}));
            },
            adj: async (uid, oldBal) => {
                const { value: amount } = await Swal.fire({
                    title: 'ปรับยอดเงินสมาชิก',
                    input: 'number',
                    inputValue: oldBal,
                    text: 'ใส่ยอดเงินใหม่ที่ต้องการ (ทับยอดเดิม)',
                    background: '#1e293b', color: '#fff', confirmButtonColor: '#D4AF37', cancelButtonColor: '#334155',
                    showCancelButton: true
                });
                if(amount) {
                    db.ref('users/'+uid).update({balance: Number(amount)});
                    Swal.fire({icon:'success', title:'ปรับยอดเรียบร้อย', timer:1000, showConfirmButton:false, background:'#1e293b', color:'#fff'});
                }
            },
            addPromo: async () => {
                const { value: form } = await Swal.fire({
                    title: 'เพิ่มโปรโมชั่น',
                    html: `
                        <input id="swal-title" class="swal2-input" placeholder="ชื่อโปรโมชั่น">
                        <input id="swal-min" type="number" class="swal2-input" placeholder="ฝากขั้นต่ำ">
                        <input id="swal-bonus" type="number" class="swal2-input" placeholder="โบนัส %">
                        <input id="swal-img" class="swal2-input" placeholder="URL รูปภาพ">
                    `,
                    focusConfirm: false, background: '#1e293b', color: '#fff', confirmButtonColor: '#D4AF37',
                    preConfirm: () => {
                        return {
                            title: document.getElementById('swal-title').value,
                            minDep: Number(document.getElementById('swal-min').value),
                            bonus: Number(document.getElementById('swal-bonus').value),
                            img: document.getElementById('swal-img').value
                        }
                    }
                });
                if(form) db.ref('promotions').push(form);
            }
        };

        // UI ROUTER
        const UI = {
            page: (p) => {
                ['dash','finance','users','banks','promos','settings'].forEach(id => {
                    document.getElementById('p-'+id).classList.add('hidden');
                    document.getElementById('nav-'+id).classList.remove('active');
                });
                document.getElementById('p-'+p).classList.remove('hidden');
                document.getElementById('p-'+p).classList.add('animate__fadeIn');
                document.getElementById('nav-'+p).classList.add('active');
                document.getElementById('page-title').innerText = p.toUpperCase();
            },
            filterTable: (tableId, text) => {
                const tr = document.getElementById(tableId).getElementsByTagName('tr');
                for(let i=0; i<tr.length; i++) {
                    tr[i].style.display = tr[i].innerText.toLowerCase().includes(text.toLowerCase()) ? '' : 'none';
                }
            }
        };
    </script>
</body>
</html>
