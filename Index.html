<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RS INFINITY | SUPER ADMIN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Kanit', 'sans-serif'] },
                    colors: { 
                        primary: '#8B5CF6', 
                        dark: '#020617',
                        card: '#0F172A',
                        accent: '#10B981'
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #020617; color: #e2e8f0; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .sidebar-item { transition: 0.3s; border-radius: 12px; margin-bottom: 4px; }
        .sidebar-item:hover, .sidebar-item.active { background: rgba(139, 92, 246, 0.2); color: #A78BFA; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
    </style>
</head>
<body class="flex min-h-screen overflow-hidden">

    <div id="authOverlay" class="fixed inset-0 z-[9999] bg-dark flex items-center justify-center p-6">
        <div class="glass w-full max-w-md p-10 rounded-3xl text-center shadow-2xl">
            <div class="w-20 h-20 bg-primary/20 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-shield-halved text-4xl text-primary"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2">Admin Login</h1>
            <p class="text-gray-500 mb-8 text-sm">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
            <div class="space-y-4">
                <input id="admEmail" type="email" class="w-full bg-black/40 border border-white/10 p-4 rounded-xl outline-none focus:border-primary transition" placeholder="Admin Email">
                <input id="admPass" type="password" class="w-full bg-black/40 border border-white/10 p-4 rounded-xl outline-none focus:border-primary transition" placeholder="Password">
                <button onclick="admin.login()" class="w-full bg-primary py-4 rounded-xl font-bold text-lg hover:shadow-[0_0_20px_rgba(139,92,246,0.4)] transition">LOGIN</button>
            </div>
        </div>
    </div>

    <aside class="w-72 glass border-r border-white/5 p-6 hidden md:flex flex-col">
        <div class="flex items-center gap-3 mb-10 px-2">
            <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center shadow-lg shadow-primary/30">
                <i class="fas fa-bolt text-white"></i>
            </div>
            <h2 class="text-xl font-bold tracking-tight">RS CONTROL</h2>
        </div>

        <nav class="flex-1">
            <button onclick="admin.changeTab('users')" id="btn-users" class="sidebar-item active w-full flex items-center gap-4 p-4 text-sm font-medium">
                <i class="fas fa-users-cog text-lg"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
            </button>
            <button onclick="admin.changeTab('config')" id="btn-config" class="sidebar-item w-full flex items-center gap-4 p-4 text-sm font-medium">
                <i class="fas fa-tools text-lg"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </nav>

        <div class="mt-auto pt-6 border-t border-white/5">
            <div id="adminProfile" class="flex items-center gap-3 mb-4 px-2">
                <div class="w-8 h-8 rounded-full bg-gray-700"></div>
                <p class="text-xs font-medium truncate w-32" id="admShowEmail">Admin</p>
            </div>
            <button onclick="admin.logout()" class="w-full text-left p-4 text-sm text-red-400 hover:text-red-300">
                <i class="fas fa-sign-out-alt mr-2"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto p-6 md:p-10 relative">
        
        <div id="tab-users" class="tab-content">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-white">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h1>
                    <p class="text-gray-500 text-sm">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</p>
                </div>
                <div class="flex gap-4">
                    <div class="glass px-6 py-4 rounded-2xl text-center">
                        <p class="text-xs text-gray-500 uppercase font-bold">Total Users</p>
                        <p id="stat-total" class="text-2xl font-bold text-primary">0</p>
                    </div>
                    <div class="glass px-6 py-4 rounded-2xl text-center">
                        <p class="text-xs text-gray-500 uppercase font-bold">Active</p>
                        <p id="stat-active" class="text-2xl font-bold text-accent">0</p>
                    </div>
                </div>
            </div>

            <div class="flex gap-4 mb-6">
                <div class="flex-1 relative">
                    <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-gray-500"></i>
                    <input oninput="admin.filter(this.value)" class="w-full bg-card border border-white/5 rounded-2xl py-4 pl-14 pr-6 outline-none focus:border-primary/50 transition" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...">
                </div>
                <button onclick="admin.loadUsers()" class="px-6 bg-card border border-white/5 rounded-2xl hover:bg-gray-800 transition"><i class="fas fa-sync-alt"></i></button>
            </div>

            <div class="glass rounded-3xl overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-white/5 text-gray-400 text-xs uppercase tracking-widest font-bold">
                        <tr>
                            <th class="p-6">User Info</th>
                            <th class="p-6">Package</th>
                            <th class="p-6">Status</th>
                            <th class="p-6">Expires At</th>
                            <th class="p-6 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody" class="divide-y divide-white/5">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="tab-config" class="tab-content hidden">
            <h1 class="text-3xl font-bold mb-8 text-white">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö (System Config)</h1>
            
            <div class="grid md:grid-cols-2 gap-8">
                <div class="glass p-8 rounded-3xl">
                    <div class="w-12 h-12 bg-blue-600/20 text-blue-500 rounded-xl flex items-center justify-center mb-6 text-xl">
                        <i class="fab fa-facebook-f"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">Facebook Support</h3>
                    <p class="text-gray-500 text-sm mb-6">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏î "‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô" (Messenger)</p>
                    <input id="cfgFb" class="w-full bg-black/40 border border-white/10 p-4 rounded-xl mb-4 outline-none focus:border-primary" placeholder="https://m.me/yourpage">
                    <button onclick="admin.saveConfig('fb')" class="bg-primary px-8 py-3 rounded-xl font-bold hover:scale-105 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Facebook</button>
                </div>

                <div class="glass p-8 rounded-3xl">
                    <div class="w-12 h-12 bg-green-600/20 text-green-500 rounded-xl flex items-center justify-center mb-6 text-xl">
                        <i class="fab fa-line"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">Line Official</h3>
                    <p class="text-gray-500 text-sm mb-6">‡∏•‡∏¥‡∏á‡∏Å‡πå Line OA (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</p>
                    <input id="cfgLine" class="w-full bg-black/40 border border-white/10 p-4 rounded-xl mb-4 outline-none focus:border-primary" placeholder="https://line.me/ti/p/...">
                    <button onclick="admin.saveConfig('line')" class="bg-accent px-8 py-3 rounded-xl font-bold hover:scale-105 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Line</button>
                </div>
            </div>
        </div>
    </main>

    <div id="editModal" class="hidden fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-6">
        <div class="glass w-full max-w-lg p-8 rounded-[2.5rem] relative shadow-2xl">
            <button onclick="document.getElementById('editModal').classList.add('hidden')" class="absolute top-6 right-6 text-gray-500 hover:text-white"><i class="fas fa-times text-2xl"></i></button>
            
            <div class="flex items-center gap-4 mb-8">
                <div class="w-14 h-14 bg-primary/20 rounded-2xl flex items-center justify-center text-primary text-2xl"><i class="fas fa-user-edit"></i></div>
                <div>
                    <h2 id="modalUserName" class="text-2xl font-bold">User Name</h2>
                    <p id="modalUserEmail" class="text-sm text-gray-500">email@example.com</p>
                </div>
            </div>

            <div class="space-y-6">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à (Plan Name)</label>
                    <select id="editPlan" class="w-full bg-black/40 border border-white/10 p-4 rounded-xl outline-none focus:border-primary">
                        <option value="Free User">Free User (‡∏ü‡∏£‡∏µ)</option>
                        <option value="VIP 30 Days">VIP 30 Days (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</option>
                        <option value="VIP 1 Year">VIP 1 Year (‡∏£‡∏≤‡∏¢‡∏õ‡∏µ)</option>
                        <option value="VVIP Lifetime">VVIP Lifetime (‡∏ï‡∏•‡∏≠‡∏î‡∏ä‡∏µ‡∏û)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label>
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <button onclick="admin.addDays(7)" class="bg-white/5 hover:bg-white/10 p-3 rounded-xl text-xs font-bold transition">+7 ‡∏ß‡∏±‡∏ô</button>
                        <button onclick="admin.addDays(30)" class="bg-white/5 hover:bg-white/10 p-3 rounded-xl text-xs font-bold transition">+30 ‡∏ß‡∏±‡∏ô</button>
                        <button onclick="admin.addDays(365)" class="bg-white/5 hover:bg-white/10 p-3 rounded-xl text-xs font-bold transition">+1 ‡∏õ‡∏µ</button>
                    </div>
                    <input type="date" id="editDate" class="w-full bg-black/40 border border-white/10 p-4 rounded-xl outline-none focus:border-primary">
                </div>

                <button onclick="admin.saveUser()" class="w-full bg-primary py-4 rounded-2xl font-bold text-lg hover:shadow-lg hover:shadow-primary/20 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, collection, getDocs, getDoc, updateDoc, setDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // üî• FIREBASE CONFIG (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
        const firebaseConfig = { apiKey: "AIzaSyBNfTBQthLLRbJP9BXZ-UQptFsdU324Mv0", authDomain: "fafada-d9899.firebaseapp.com", projectId: "fafada-d9899", storageBucket: "fafada-d9899.firebasestorage.app", messagingSenderId: "484777586908", appId: "1:484777586908:web:16a8f0367ad15737364419" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allUsers = [];
        let editingUid = null;

        window.admin = {
            login: async () => {
                const e = document.getElementById('admEmail').value;
                const p = document.getElementById('admPass').value;
                try {
                    await signInWithEmailAndPassword(auth, e, p);
                    Swal.fire({ icon: 'success', title: 'Welcome Admin', showConfirmButton: false, timer: 1500 });
                } catch(err) { Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ', 'error'); }
            },
            logout: () => signOut(auth).then(()=>location.reload()),

            changeTab: (tab) => {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
                document.getElementById('tab-'+tab).classList.remove('hidden');
                document.getElementById('btn-'+tab).classList.add('active');
                if(tab === 'config') admin.loadConfig();
            },

            loadUsers: async () => {
                const tbody = document.getElementById('userTableBody');
                tbody.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading Database...</td></tr>';
                
                try {
                    const sn = await getDocs(collection(db, "users"));
                    allUsers = [];
                    sn.forEach(doc => allUsers.push({ id: doc.id, ...doc.data() }));
                    admin.renderTable(allUsers);
                    
                    // Stats
                    document.getElementById('stat-total').innerText = allUsers.length;
                    document.getElementById('stat-active').innerText = allUsers.filter(u => u.expiryDate && u.expiryDate.toDate() > new Date()).length;
                } catch(e) { console.error(e); }
            },

            renderTable: (users) => {
                const tbody = document.getElementById('userTableBody');
                tbody.innerHTML = '';
                users.forEach(u => {
                    const now = new Date();
                    const expiry = u.expiryDate ? u.expiryDate.toDate() : null;
                    const isActive = expiry && expiry > now;

                    tbody.innerHTML += `
                        <tr class="hover:bg-white/[0.02] transition">
                            <td class="p-6">
                                <div class="font-bold text-white">${u.displayName || 'No Name'}</div>
                                <div class="text-xs text-gray-500 font-mono">${u.email}</div>
                            </td>
                            <td class="p-6 text-sm font-medium text-primary">${u.planName || 'Free'}</td>
                            <td class="p-6">
                                ${isActive ? '<span class="px-3 py-1 bg-accent/10 text-accent text-[10px] font-bold rounded-full border border-accent/20">ACTIVE</span>' : '<span class="px-3 py-1 bg-red-500/10 text-red-500 text-[10px] font-bold rounded-full border border-red-500/20">EXPIRED</span>'}
                            </td>
                            <td class="p-6 text-sm text-gray-400">
                                ${expiry ? moment(expiry).format('DD/MM/YYYY HH:mm') : '-'}
                            </td>
                            <td class="p-6 text-right">
                                <button onclick="admin.openEdit('${u.id}')" class="w-10 h-10 bg-white/5 hover:bg-primary hover:text-white rounded-xl transition"><i class="fas fa-pen-nib"></i></button>
                            </td>
                        </tr>
                    `;
                });
            },

            filter: (q) => {
                const search = q.toLowerCase();
                const filtered = allUsers.filter(u => (u.displayName||'').toLowerCase().includes(search) || u.email.toLowerCase().includes(search));
                admin.renderTable(filtered);
            },

            openEdit: (uid) => {
                const u = allUsers.find(x => x.id === uid);
                editingUid = uid;
                document.getElementById('modalUserName').innerText = u.displayName;
                document.getElementById('modalUserEmail').innerText = u.email;
                document.getElementById('editPlan').value = u.planName || 'Free User';
                if(u.expiryDate) document.getElementById('editDate').value = u.expiryDate.toDate().toISOString().split('T')[0];
                document.getElementById('editModal').classList.remove('hidden');
            },

            addDays: (days) => {
                let base = new Date();
                const user = allUsers.find(u => u.id === editingUid);
                if(user.expiryDate && user.expiryDate.toDate() > base) base = user.expiryDate.toDate();
                base.setDate(base.getDate() + days);
                document.getElementById('editDate').value = base.toISOString().split('T')[0];
            },

            saveUser: async () => {
                const plan = document.getElementById('editPlan').value;
                const date = document.getElementById('editDate').value;
                const expiry = date ? Timestamp.fromDate(new Date(date + "T23:59:59")) : null;

                try {
                    await updateDoc(doc(db, "users", editingUid), { planName: plan, expiryDate: expiry });
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    document.getElementById('editModal').classList.add('hidden');
                    admin.loadUsers();
                } catch(e) { Swal.fire('Error', e.message, 'error'); }
            },

            // ‚öôÔ∏è CONFIG LOGIC
            loadConfig: async () => {
                const d = await getDoc(doc(db, "system", "config"));
                if(d.exists()) {
                    const data = d.data();
                    document.getElementById('cfgFb').value = data.fb || '';
                    document.getElementById('cfgLine').value = data.line || '';
                }
            },
            saveConfig: async (type) => {
                const val = type === 'fb' ? document.getElementById('cfgFb').value : document.getElementById('cfgLine').value;
                try {
                    await setDoc(doc(db, "system", "config"), { [type]: val }, { merge: true });
                    Swal.fire('Saved', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                } catch(e) { Swal.fire('Error', e.message, 'error'); }
            }
        };

        onAuthStateChanged(auth, u => {
            if(u) {
                document.getElementById('authOverlay').classList.add('hidden');
                document.getElementById('admShowEmail').innerText = u.email;
                admin.loadUsers();
            } else {
                document.getElementById('authOverlay').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
