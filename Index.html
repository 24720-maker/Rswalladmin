<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN PANEL - GOD MODE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { background: #0f172a; color: #cbd5e1; font-family: 'Kanit'; }
        .card { background: #1e293b; border: 1px solid #334155; padding: 20px; border-radius: 12px; }
        .btn-act { padding: 5px 15px; border-radius: 6px; font-size: 0.8rem; transition: 0.2s; }
        .btn-act:hover { filter: brightness(1.1); }
    </style>
</head>
<body class="p-8">

    <h1 class="text-3xl font-bold text-yellow-500 mb-8 border-b border-gray-700 pb-4">ADMIN DASHBOARD</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        
        <div class="card">
            <h3 class="text-xl font-bold text-white mb-4">รายการรออนุมัติ (ฝาก/ถอน)</h3>
            <div id="tx-list" class="space-y-3 max-h-[500px] overflow-y-auto">
                <p class="text-center text-gray-600">ไม่มีรายการ</p>
            </div>
        </div>

        <div class="card">
            <h3 class="text-xl font-bold text-white mb-4">รายชื่อสมาชิก</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead><tr class="text-gray-500 border-b border-gray-700"><th>ชื่อ</th><th>ยอดเงิน</th><th>ปรับ</th></tr></thead>
                    <tbody id="user-list"></tbody>
                </table>
            </div>
        </div>

    </div>

    <div class="card mt-8">
        <h3 class="text-xl font-bold text-white mb-4">ห้องเกมที่กำลังเล่น</h3>
        <div id="room-list" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDc50wlOejDQi3PTySiQss3bLuVz_-tvB4", authDomain: "walletrs-d6104.firebaseapp.com", projectId: "walletrs-d6104", storageBucket: "walletrs-d6104.firebasestorage.app", messagingSenderId: "496661515180", appId: "1:496661515180:web:42c3a21541cdfc68cf8809", measurementId: "G-2P8SGLR602", databaseURL: "https://walletrs-d6104-default-rtdb.asia-southeast1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. Transactions
        db.ref('transactions').orderByChild('status').equalTo('pending').on('value', s => {
            const l = document.getElementById('tx-list'); l.innerHTML = '';
            if(!s.exists()) { l.innerHTML = '<p class="text-center text-gray-600">ไม่มีรายการ</p>'; return; }
            s.forEach(d => {
                const t = d.val();
                l.innerHTML += `
                    <div class="bg-[#0f172a] p-3 rounded-lg border-l-4 ${t.type=='deposit'?'border-green-500':'border-red-500'} flex justify-between items-center">
                        <div>
                            <div class="font-bold text-white">${t.type.toUpperCase()} ฿${t.amount}</div>
                            <div class="text-xs text-gray-400">${t.name}</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="Tx('${d.key}','ok','${t.uid}',${t.amount},'${t.type}')" class="btn-act bg-green-600 text-white">อนุมัติ</button>
                            <button onclick="Tx('${d.key}','no','${t.uid}',${t.amount},'${t.type}')" class="btn-act bg-red-600 text-white">ปฏิเสธ</button>
                        </div>
                    </div>`;
            });
        });

        // 2. Users
        db.ref('users').on('value', s => {
            const l = document.getElementById('user-list'); l.innerHTML = '';
            s.forEach(d => {
                const u = d.val();
                l.innerHTML += `
                    <tr class="border-b border-gray-800">
                        <td class="py-2 text-white">${u.name}</td>
                        <td class="text-yellow-500 font-bold">฿${u.balance}</td>
                        <td><button onclick="Adj('${d.key}')" class="text-blue-400 hover:text-white">✏️</button></td>
                    </tr>`;
            });
        });

        // 3. Rooms
        db.ref('rooms').on('value', s => {
            const l = document.getElementById('room-list'); l.innerHTML = '';
            s.forEach(d => {
                const r = d.val();
                l.innerHTML += `
                    <div class="bg-[#0f172a] p-3 rounded border border-gray-700">
                        <div class="flex justify-between mb-2">
                            <span class="text-yellow-500 font-bold">฿${r.bet}</span>
                            <span class="text-xs bg-gray-700 px-2 rounded text-white">${r.status}</span>
                        </div>
                        <div class="text-xs text-gray-400 flex justify-between">
                            <span>P1: ${r.p1.name}</span>
                            <span>P2: ${r.p2?r.p2.name:'-'}</span>
                        </div>
                        <button onclick="db.ref('rooms/${d.key}').remove()" class="mt-2 w-full bg-red-900/50 text-red-400 text-xs py-1 rounded hover:bg-red-500 hover:text-white">ลบห้อง</button>
                    </div>`;
            });
        });

        // Actions
        window.Tx = (key, action, uid, amt, type) => {
            if(action === 'ok') {
                db.ref('transactions/'+key).update({status:'approved'});
                if(type === 'deposit') {
                    db.ref('users/'+uid+'/balance').once('value', s => db.ref('users/'+uid).update({balance:(s.val()||0)+amt}));
                }
            } else {
                db.ref('transactions/'+key).update({status:'rejected'});
                if(type === 'withdraw') { // Refund logic
                    db.ref('users/'+uid+'/balance').once('value', s => db.ref('users/'+uid).update({balance:(s.val()||0)+amt}));
                }
            }
        };

        window.Adj = async (uid) => {
            const {value: amt} = await Swal.fire({title:'แก้ไขยอดเงิน', input:'number', background:'#1e293b', color:'#fff'});
            if(amt) db.ref('users/'+uid).update({balance:Number(amt)});
        };
    </script>
</body>
</html>
