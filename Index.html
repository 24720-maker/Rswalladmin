<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RS ADMIN | ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=Prompt:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Kanit', 'sans-serif'], title: ['Prompt', 'sans-serif'] },
                    colors: { brand: '#0052FF', luxury: '#0f172a', bgDark: '#0f172a' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; font-family: 'Kanit', sans-serif; }
        .admin-sidebar { background: #0f172a; height: 100vh; position: sticky; top: 0; }
        .stat-card { background: white; border-radius: 1.5rem; border: 1px solid #f1f5f9; transition: 0.3s; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); }
        .nav-link { padding: 1rem 1.5rem; border-radius: 1rem; color: #94a3b8; transition: 0.3s; display: flex; align-items: center; gap: 1rem; }
        .nav-link.active { background: #0052FF; color: white; box-shadow: 0 10px 15px -3px rgba(0, 82, 255, 0.4); }
        .table-row:hover { background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex">

    <div id="loader" class="fixed inset-0 z-[1000] bg-white flex flex-col items-center justify-center transition-all duration-500">
        <div class="w-12 h-12 border-4 border-slate-100 border-t-brand rounded-full animate-spin"></div>
        <p class="mt-4 text-brand font-black uppercase text-xs tracking-widest animate-pulse">Authenticating Admin...</p>
    </div>

    <div id="authPage" class="hidden fixed inset-0 z-[900] bg-slate-900/50 backdrop-blur-xl flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm p-10 rounded-[3rem] text-center shadow-2xl">
            <h1 class="text-3xl font-black text-luxury mb-2 font-title italic">ADMIN <span class="text-brand">LOGIN</span></h1>
            <p class="text-slate-400 text-xs font-bold mb-8 uppercase tracking-widest">RS SUPREME MANAGEMENT</p>
            <input id="lEmail" type="email" class="w-full p-4 bg-slate-50 border rounded-2xl mb-4 font-bold outline-none" placeholder="Email">
            <input id="lPass" type="password" class="w-full p-4 bg-slate-50 border rounded-2xl mb-6 font-bold outline-none" placeholder="Password">
            <button onclick="admin.login()" class="w-full bg-brand text-white py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg">Enter Dashboard</button>
        </div>
    </div>

    <aside class="admin-sidebar w-72 p-6 flex flex-col hidden lg:flex">
        <div class="flex items-center gap-3 mb-10 px-4">
            <div class="w-10 h-10 bg-brand rounded-xl flex items-center justify-center text-white font-black italic">RS</div>
            <h2 class="text-white font-black text-lg font-title tracking-tight">RS CONSOLE</h2>
        </div>
        
        <nav class="space-y-2 flex-1">
            <button onclick="ui.view('dash')" id="n-dash" class="nav-link active w-full"><i class="fas fa-chart-pie w-5 text-center"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</button>
            <button onclick="ui.view('users')" id="n-users" class="nav-link w-full"><i class="fas fa-users w-5 text-center"></i> ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å & ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
            <button onclick="ui.view('wallet')" id="n-wallet" class="nav-link w-full"><i class="fas fa-wallet w-5 text-center"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</button>
            <button onclick="ui.view('orders')" id="n-orders" class="nav-link w-full"><i class="fas fa-truck-loading w-5 text-center"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
            <button onclick="ui.view('system')" id="n-system" class="nav-link w-full"><i class="fas fa-cog w-5 text-center"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</button>
        </nav>

        <button onclick="admin.logout()" class="text-rose-500 font-bold text-sm px-4 mt-10 hover:underline"><i class="fas fa-power-off mr-2"></i> Log out</button>
    </aside>

    <main class="flex-1 overflow-y-auto no-scrollbar p-10 hidden" id="mainDashboard">
        
        <section id="v-dash" class="space-y-10 fade-in">
            <header class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-black text-luxury font-title">Dashboard</h1>
                    <p class="text-slate-400 text-sm font-bold uppercase tracking-widest mt-1">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="stat-card p-8"><p class="text-xs font-bold text-slate-400 uppercase mb-2">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p><h3 id="statBal" class="text-4xl font-black text-brand italic">‡∏ø 0.00</h3></div>
                <div class="stat-card p-8"><p class="text-xs font-bold text-slate-400 uppercase mb-2">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p><h3 id="statUsers" class="text-4xl font-black text-luxury italic">0 ‡∏Ñ‡∏ô</h3></div>
                <div class="stat-card p-8"><p class="text-xs font-bold text-slate-400 uppercase mb-2">‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p><h3 id="statOrders" class="text-4xl font-black text-amber-500 italic">0 ‡∏á‡∏≤‡∏ô</h3></div>
            </div>
        </section>

        <section id="v-users" class="hidden space-y-8 fade-in">
            <h1 class="text-3xl font-black text-luxury font-title">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å & ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h1>
            <div class="bg-white rounded-[2rem] overflow-hidden border border-slate-100 shadow-sm">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                        <tr><th class="p-6">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
                    </thead>
                    <tbody id="userTable"></tbody>
                </table>
            </div>
        </section>

        <section id="v-wallet" class="hidden space-y-8 fade-in">
            <h1 class="text-3xl font-black text-luxury font-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                <div class="bg-white p-10 rounded-[2.5rem] border border-slate-100 shadow-sm space-y-6">
                    <h3 class="font-bold text-slate-400 uppercase text-xs tracking-widest">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏î‡πà‡∏ß‡∏ô</h3>
                    <input id="uSearch" class="w-full p-5 bg-slate-50 border-none rounded-2xl font-bold" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ UID ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
                    <input id="uAmount" type="number" class="w-full p-5 bg-slate-50 border-none rounded-2xl font-bold text-4xl text-brand" placeholder="‡∏ø0.00">
                    <textarea id="uReason" rows="3" class="w-full p-5 bg-slate-50 border-none rounded-2xl font-bold" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï, ‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á)"></textarea>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="admin.adjustCredit('add')" class="py-5 bg-brand text-white rounded-2xl font-black uppercase tracking-widest shadow-lg shadow-brand/20">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
                        <button onclick="admin.adjustCredit('minus')" class="py-5 bg-rose-500 text-white rounded-2xl font-black uppercase tracking-widest shadow-lg shadow-rose-500/20">- ‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="v-orders" class="hidden space-y-8 fade-in">
            <h1 class="text-3xl font-black text-luxury font-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏û‡∏±‡∏™‡∏î‡∏∏</h1>
            <div id="orderList" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </section>

        <section id="v-system" class="hidden space-y-8 fade-in">
            <h1 class="text-3xl font-black text-luxury font-title">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö</h1>
            <div class="bg-white p-10 rounded-[2.5rem] border border-slate-100 shadow-sm max-w-2xl">
                <textarea id="sysNews" rows="4" class="w-full p-6 bg-slate-50 rounded-2xl font-bold mb-6" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                <button onclick="admin.updateNews()" class="w-full bg-brand text-white py-5 rounded-2xl font-black uppercase shadow-xl">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
            </div>
        </section>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, updateDoc, setDoc, query, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBNfTBQthLLRbJP9BXZ-UQptFsdU324Mv0", authDomain: "fafada-d9899.firebaseapp.com", projectId: "fafada-d9899", storageBucket: "fafada-d9899.firebasestorage.app", messagingSenderId: "484777586908", appId: "1:484777586908:web:16a8f0367ad15737364419" };
        const app_fb = initializeApp(firebaseConfig);
        const auth = getAuth(app_fb);
        const db = getFirestore(app_fb);

        window.ui = {
            view: (v) => {
                document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
                document.getElementById('v-'+v).classList.remove('hidden');
                document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
                document.getElementById('n-'+v).classList.add('active');
            }
        };

        window.admin = {
            login: async () => {
                const em = document.getElementById('lEmail').value.trim();
                const ps = document.getElementById('lPass').value.trim();
                if(em !== 'farisxuma1@gmail.com') return Swal.fire('Error','‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô','error');
                try { await signInWithEmailAndPassword(auth, em, ps); } catch(e) { Swal.fire('Error','‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î','error'); }
            },
            logout: () => signOut(auth).then(()=>location.reload()),
            approveUser: async (uid) => {
                Swal.showLoading();
                await updateDoc(doc(db, "users", uid), { isApproved: true, balance: 0 });
                Swal.fire({icon:'success',title:'‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',timer:1500,showConfirmButton:false});
            },
            adjustCredit: async (type) => {
                const uid = document.getElementById('uSearch').value.trim();
                const val = parseFloat(document.getElementById('uAmount').value);
                const reason = document.getElementById('uReason').value;
                if(!uid || isNaN(val)) return Swal.fire('Error','‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','warning');
                
                Swal.showLoading();
                try {
                    await runTransaction(db, async (t) => {
                        const uRef = doc(db, "users", uid);
                        const uSnap = await t.get(uRef);
                        const cur = uSnap.data().balance || 0;
                        const newBal = type === 'add' ? cur + val : cur - val;
                        t.update(uRef, { balance: newBal });
                        
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                        const txRef = doc(collection(db, "transactions"));
                        t.set(txRef, { uid: uid, amount: type === 'add' ? val : -val, type: 'adjustment', status: 'completed', reason: reason, timestamp: serverTimestamp() });
                    });
                    Swal.fire('Success','‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','success');
                } catch(e) { Swal.fire('Error',e.message,'error'); }
            },
            updateNews: async () => {
                const txt = document.getElementById('sysNews').value;
                await setDoc(doc(db, "announcements", "main"), { content: txt, title: 'ADMIN UPDATED' });
                Swal.fire('Updated','‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
            }
        };

        // üîó Real-time Data Hub
        onAuthStateChanged(auth, u => {
            if(u && u.email === 'farisxuma1@gmail.com') {
                document.getElementById('authPage').classList.add('hidden');
                document.getElementById('mainDashboard').classList.remove('hidden');
                document.getElementById('loader').classList.add('hidden');

                // Sync Users
                onSnapshot(collection(db, "users"), s => {
                    const list = s.docs.map(d => ({id: d.id, ...d.data()}));
                    const tb = document.getElementById('userTable'); tb.innerHTML = '';
                    let totalBal = 0;
                    
                    list.forEach(user => {
                        totalBal += user.balance || 0;
                        tb.innerHTML += `
                        <tr class="table-row border-b border-slate-50 transition-all">
                            <td class="p-6">
                                <p class="font-bold text-luxury">${user.displayName}</p>
                                <p class="text-[9px] font-mono text-slate-400 uppercase">${user.id}</p>
                            </td>
                            <td class="text-xs font-black uppercase text-brand">${user.role}</td>
                            <td class="font-bold italic text-luxury">‡∏ø${(user.balance || 0).toLocaleString()}</td>
                            <td>
                                ${user.isApproved ? '<span class="status-badge bg-emerald-50 text-success">Approved</span>' : '<span class="status-badge bg-amber-50 text-amber-500 animate-pulse">Pending</span>'}
                            </td>
                            <td class="text-center">
                                ${!user.isApproved ? `<button onclick="admin.approveUser('${user.id}')" class="px-4 py-2 bg-brand text-white rounded-lg text-[10px] font-black uppercase shadow-lg shadow-brand/20">Approve</button>` : `<button onclick="document.getElementById('uSearch').value='${user.id}'; ui.view('wallet')" class="px-4 py-2 bg-slate-100 text-slate-500 rounded-lg text-[10px] font-black uppercase">Edit Bal</button>`}
                            </td>
                        </tr>`;
                    });
                    document.getElementById('statBal').innerText = `‡∏ø ${totalBal.toLocaleString()}`;
                    document.getElementById('statUsers').innerText = list.length + " ‡∏Ñ‡∏ô";
                });

                // Sync Orders
                onSnapshot(collection(db, "shipments"), s => {
                    const orders = s.docs.map(d => ({id: d.id, ...d.data()}));
                    document.getElementById('statOrders').innerText = orders.filter(o => o.status === 'pending').length + " ‡∏á‡∏≤‡∏ô";
                    const ol = document.getElementById('orderList'); ol.innerHTML = '';
                    orders.forEach(o => {
                        ol.innerHTML += `
                        <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex flex-col gap-4">
                            <div class="flex justify-between"><span class="text-[9px] font-black text-brand uppercase">Order ID: #${o.id.slice(0,8)}</span><span class="status-pill bg-slate-50 text-slate-500 text-[10px] font-bold uppercase px-3 py-1 rounded-full">${o.status}</span></div>
                            <div class="space-y-2">
                                <p class="text-xs font-bold text-luxury italic">‡∏à‡∏≤‡∏Å: ${o.pickupAddress}</p>
                                <p class="text-xs font-bold text-luxury italic">‡∏ñ‡∏∂‡∏á: ${o.deliveryAddress}</p>
                            </div>
                        </div>`;
                    });
                });

                // Get Current News
                onSnapshot(doc(db, "announcements", "main"), s => { if(s.exists()) document.getElementById('sysNews').value = s.data().content; });

            } else {
                document.getElementById('authPage').classList.remove('hidden');
                document.getElementById('loader').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
