<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RS ADMIN | PLATINUM CONTROL v11.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&family=Prompt:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Prompt', 'sans-serif'], display: ['Outfit', 'sans-serif'] },
                    colors: { adm: '#020617', brand: '#0052FF', success: '#10b981', danger: '#f43f5e', surface: '#0f172a' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #020617; color: #f1f5f9; overflow: hidden; height: 100vh; font-family: 'Prompt', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .nav-active { background: linear-gradient(90deg, rgba(0, 82, 255, 0.2) 0%, transparent 100%); border-left: 4px solid #0052FF; color: white; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        input, textarea, select { background: #0f172a !important; border: 1px solid #1e293b !important; color: white !important; outline: none !important; transition: 0.3s; }
        input:focus { border-color: #0052FF !important; box-shadow: 0 0 0 1px rgba(0, 82, 255, 0.2); }
        
        .bank-card { border: 2px solid #1e293b; transition: 0.3s; cursor: pointer; }
        .bank-card.active { border-color: #0052FF; background: rgba(0, 82, 255, 0.1); }
        .status-badge { font-size: 8px; font-weight: 900; padding: 2px 8px; border-radius: 6px; text-transform: uppercase; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <div id="loader" class="fixed inset-0 z-[1000] bg-adm flex flex-col items-center justify-center">
        <div class="relative w-16 h-16 flex items-center justify-center">
            <div class="absolute inset-0 border-2 border-slate-800 rounded-full"></div>
            <div class="absolute inset-0 border-2 border-brand rounded-full border-t-transparent animate-spin"></div>
            <span class="text-brand font-black italic text-xs">RS</span>
        </div>
        <p class="mt-6 text-slate-500 font-bold tracking-[0.4em] text-[9px] uppercase animate-pulse">Establishing Secure Uplink</p>
    </div>

    <aside class="w-64 bg-slate-950 border-r border-slate-900 flex flex-col z-50">
        <div class="p-8 flex flex-col items-center border-b border-slate-900">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-brand rounded-xl flex items-center justify-center text-white font-black shadow-lg shadow-brand/20 italic">RS</div>
                <h1 class="text-xl font-black italic tracking-tighter text-white font-display uppercase">Admin</h1>
            </div>
            <span class="text-[8px] bg-slate-800 text-slate-400 px-3 py-1 rounded-full font-black mt-4 tracking-widest border border-slate-700 uppercase">Platinum Terminal</span>
        </div>
        
        <nav class="p-4 space-y-1 flex-1 overflow-y-auto no-scrollbar">
            <button onclick="adm.tab('dash')" id="m-dash" class="w-full text-left px-5 py-3.5 rounded-xl hover:bg-slate-900 transition flex items-center gap-3 nav-active font-bold text-xs"><i class="fas fa-chart-pie text-[12px]"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
            <button onclick="adm.tab('req')" id="m-req" class="w-full text-left px-5 py-3.5 rounded-xl hover:bg-slate-900 transition flex justify-between items-center font-bold text-xs text-slate-400">
                <span class="flex items-center gap-3"><i class="fas fa-bolt-lightning text-[12px] text-warning"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                <span id="badge" class="bg-danger text-white text-[9px] font-black px-1.5 py-0.5 rounded-md hidden">0</span>
            </button>
            <button onclick="adm.tab('users')" id="m-users" class="w-full text-left px-5 py-3.5 rounded-xl hover:bg-slate-900 transition flex items-center gap-3 font-bold text-xs text-slate-400"><i class="fas fa-users-gear text-[12px] text-brand"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
            <button onclick="adm.tab('set')" id="m-set" class="w-full text-left px-5 py-3.5 rounded-xl hover:bg-slate-900 transition flex items-center gap-3 font-bold text-xs text-slate-400"><i class="fas fa-building-columns text-[12px]"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</button>
        </nav>

        <div class="p-5 border-t border-slate-900 bg-adm">
            <div class="flex items-center gap-3 mb-4 px-2">
                <div class="w-8 h-8 rounded-lg bg-slate-900 flex items-center justify-center text-slate-500 border border-slate-800"><i class="fas fa-user-shield text-xs"></i></div>
                <div class="overflow-hidden">
                    <p id="admEmail" class="text-[9px] text-slate-300 font-bold truncate">...</p>
                    <p class="text-[7px] text-emerald-500 font-black tracking-widest">‚óè SYSTEM ONLINE</p>
                </div>
            </div>
            <button onclick="adm.logout()" class="w-full bg-slate-900 text-rose-500 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest border border-slate-800 active:scale-95 transition-all">Logout</button>
        </div>
    </aside>

    <main class="flex-1 p-10 overflow-y-auto bg-adm no-scrollbar relative">
        
        <div id="t-dash" class="space-y-10 fade-in">
            <div class="flex justify-between items-end">
                <div class="space-y-1">
                    <h2 class="text-3xl font-black text-white italic font-display uppercase leading-none">Command Center</h2>
                    <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</p>
                </div>
                <div class="bg-slate-950 border border-slate-900 px-5 py-2.5 rounded-2xl flex items-center gap-3">
                    <i class="fas fa-clock text-brand text-xs"></i>
                    <span id="realTime" class="text-[11px] font-black font-display tracking-widest text-slate-400 uppercase">...</span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="glass p-7 rounded-[2rem] border-b-2 border-brand">
                    <p class="text-slate-500 text-[9px] font-black uppercase tracking-widest mb-3">Total Balance</p>
                    <h3 class="text-3xl font-black text-white italic font-display">‡∏ø<span id="stBal">0</span></h3>
                </div>
                <div class="glass p-7 rounded-[2rem] border-b-2 border-warning">
                    <p class="text-slate-500 text-[9px] font-black uppercase tracking-widest mb-3">Pending Tasks</p>
                    <h3 class="text-3xl font-black text-warning italic font-display" id="stPen">0</h3>
                </div>
                <div class="glass p-7 rounded-[2rem] border-b-2 border-success">
                    <p class="text-slate-500 text-[9px] font-black uppercase tracking-widest mb-3">Verified Users</p>
                    <h3 class="text-3xl font-black text-success italic font-display" id="stUsr">0</h3>
                </div>
                <div class="glass p-7 rounded-[2rem] border-b-2 border-indigo-500">
                    <p class="text-slate-500 text-[9px] font-black uppercase tracking-widest mb-3">Daily Volume</p>
                    <h3 class="text-3xl font-black text-indigo-400 italic font-display" id="stDaily">‡∏ø0</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 glass p-8 rounded-[2.5rem]">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="font-black text-white text-[11px] tracking-widest uppercase"><i class="fas fa-history mr-2 text-brand"></i> ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                        <button onclick="adm.tab('req')" class="text-brand text-[9px] font-black hover:underline uppercase tracking-widest">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    </div>
                    <div id="recentLogs" class="space-y-3"></div>
                </div>
                <div class="glass p-8 rounded-[2.5rem]">
                    <h3 class="font-black text-white text-[11px] tracking-widest uppercase mb-8"><i class="fas fa-bullhorn mr-2 text-warning"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏î‡πà‡∏ß‡∏ô</h3>
                    <textarea id="admNotice" rows="5" class="w-full p-5 rounded-2xl text-[13px] italic border-slate-800 leading-relaxed mb-4" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ß‡∏¥‡πà‡∏á‡πÉ‡∏ô‡πÄ‡∏ß‡πá‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..."></textarea>
                    <button onclick="adm.saveNotice()" class="w-full bg-warning text-adm py-4 rounded-xl font-black text-[10px] uppercase tracking-widest active:scale-95 transition-all">Update Announcement</button>
                </div>
            </div>
        </div>

        <div id="t-req" class="hidden space-y-8 fade-in">
            <h2 class="text-3xl font-black text-white italic font-display uppercase leading-none italic uppercase">Approvals Terminal</h2>
            <div class="glass rounded-[2.5rem] overflow-hidden border border-slate-900 shadow-2xl">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-950 text-[9px] font-black text-slate-500 uppercase tracking-widest border-b border-slate-900">
                        <tr>
                            <th class="p-7">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
                            <th class="p-7">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó / ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
                            <th class="p-7 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)</th>
                            <th class="p-7 text-center">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="tbReq" class="divide-y divide-slate-900"></tbody>
                </table>
                <div id="noReq" class="hidden p-32 text-center text-slate-700 font-bold italic text-xs uppercase tracking-widest">No Active Requests Found</div>
            </div>
        </div>

        <div id="t-users" class="hidden space-y-8 fade-in">
            <div class="flex justify-between items-center">
                <div class="space-y-1">
                    <h2 class="text-3xl font-black text-white italic font-display uppercase leading-none">Personnel Database</h2>
                    <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏î‡∏∏‡∏•‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</p>
                </div>
                <div class="relative">
                    <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-600 text-xs"></i>
                    <input onkeyup="adm.searchU(this.value)" class="bg-slate-950 border border-slate-900 rounded-xl py-3.5 pl-12 pr-6 text-xs text-white focus:ring-1 focus:ring-brand w-80 outline-none font-bold" placeholder="‡∏Ñ‡πâ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ UID...">
                </div>
            </div>
            <div id="grUsr" class="grid grid-cols-1 md:grid-cols-2 2xl:grid-cols-3 gap-6"></div>
        </div>

        <div id="t-set" class="hidden space-y-10 fade-in">
            <div class="space-y-1 text-center max-w-2xl mx-auto mb-12">
                <h2 class="text-3xl font-black text-white italic font-display uppercase leading-none">Financial Matrix</h2>
                <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 glass p-10 rounded-[3.5rem] border-t-4 border-brand">
                    <h3 class="text-[11px] font-black uppercase text-slate-400 tracking-widest mb-10 flex items-center gap-3"><i class="fas fa-toggle-on text-brand"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏ù‡∏≤‡∏Å</h3>
                    <div id="bankToggleList" class="grid grid-cols-3 gap-5">
                        </div>
                </div>

                <div class="glass p-10 rounded-[3.5rem] border-t-4 border-indigo-500 space-y-8">
                    <h3 class="text-[11px] font-black uppercase text-slate-400 tracking-widest italic">Admin Finance Accounts</h3>
                    <div class="space-y-6">
                        <div class="space-y-2">
                            <label class="text-[9px] font-black text-slate-600 uppercase ml-4">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</label>
                            <textarea id="cfgBank" rows="3" class="w-full p-4 rounded-2xl font-bold text-brand text-xs leading-relaxed" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£\n‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ\n‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á"></textarea>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[9px] font-black text-slate-600 uppercase ml-4">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ß‡∏≠‡πÄ‡∏•‡∏ó‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</label>
                            <input id="cfgWalletAcc" type="text" class="w-full p-4 rounded-xl font-bold text-orange-400 text-xs" placeholder="0xx-xxxxxxx">
                        </div>
                        <div class="flex gap-4">
                            <div class="flex-1 space-y-2">
                                <label class="text-[9px] font-black text-slate-600 uppercase ml-4">‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ß‡∏≠‡πÄ‡∏•‡∏ó (%)</label>
                                <input id="cfgWalletFee" type="number" class="w-full p-4 rounded-xl font-black text-xs">
                            </div>
                            <div class="flex-1 space-y-2">
                                <label class="text-[9px] font-black text-slate-600 uppercase ml-4">‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ñ‡∏≠‡∏ô (%)</label>
                                <input id="cfgWithdrawFee" type="number" class="w-full p-4 rounded-xl font-black text-xs">
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[9px] font-black text-slate-600 uppercase ml-4">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Facebook</label>
                            <input id="cfgLink" type="text" class="w-full p-4 rounded-xl text-blue-400 font-bold text-xs" placeholder="facebook.com/username">
                        </div>
                        <button onclick="adm.saveFinance()" class="w-full bg-brand py-5 rounded-[1.5rem] font-black text-[10px] uppercase tracking-widest shadow-2xl shadow-brand/20 active:scale-95 transition-all mt-4 border border-white/10">Synchronize Protocol</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, runTransaction, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // üî• FIREBASE CONFIG (Sync with customer app)
        const firebaseConfig = { apiKey: "AIzaSyBNfTBQthLLRbJP9BXZ-UQptFsdU324Mv0", authDomain: "fafada-d9899.firebaseapp.com", projectId: "fafada-d9899", storageBucket: "fafada-d9899.firebasestorage.app", messagingSenderId: "484777586908", appId: "1:484777586908:web:16a8f0367ad15737364419" };
        const app_fb = initializeApp(firebaseConfig);
        const auth = getAuth(app_fb);
        const db = getFirestore(app_fb);

        const BANK_MASTER = {
            kbank: { name: '‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢', icon: 'https://cdn-icons-png.flaticon.com/128/10237/10237035.png' },
            scb: { name: '‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå', icon: 'https://cdn-icons-png.flaticon.com/128/10237/10237038.png' },
            ktb: { name: '‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢', icon: 'https://cdn-icons-png.flaticon.com/128/10237/10237040.png' },
            bbl: { name: '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û', icon: 'https://cdn-icons-png.flaticon.com/128/10237/10237037.png' },
            gsb: { name: '‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô', icon: 'https://cdn-icons-png.flaticon.com/128/10237/10237039.png' },
            wallet: { name: '‡∏ó‡∏£‡∏π‡∏ß‡∏≠‡πÄ‡∏•‡∏ó', icon: 'https://cdn-icons-png.flaticon.com/128/10237/10237036.png' }
        };

        let allUsers = [], sysConfig = {}, allTx = [];

        onAuthStateChanged(auth, u => {
            if(u && u.email === 'farisxuma1@gmail.com'){
                document.getElementById('loader').remove();
                document.getElementById('admEmail').innerText = u.email.toUpperCase();
                adm.init();
            } else {
                Swal.fire({
                    title: 'ADMIN AUTH', background: '#020617', color: '#fff',
                    html: '<div class="space-y-4"><input id="e" class="swal2-input" placeholder="Admin Email"><input id="p" type="password" class="swal2-input" placeholder="Password"></div>',
                    confirmButtonText: 'Authorize', preConfirm: () => [document.getElementById('e').value, document.getElementById('p').value]
                }).then(r => {
                    if(r.value) signInWithEmailAndPassword(auth, r.value[0], r.value[1]).catch(()=>location.reload());
                });
            }
        });

        setInterval(() => { document.getElementById('realTime').innerText = moment().format('HH:mm:ss | DD MMM YYYY'); }, 1000);

        window.adm = {
            tab: (t)=>{ 
                document.querySelectorAll('[id^="t-"]').forEach(e=>e.classList.add('hidden')); 
                document.getElementById('t-'+t).classList.remove('hidden'); 
                document.querySelectorAll('[id^="m-"]').forEach(e=>e.classList.remove('nav-active'));
                document.querySelectorAll('[id^="m-"]').forEach(e=>e.classList.add('text-slate-400'));
                document.getElementById('m-'+t).classList.add('nav-active'); 
                document.getElementById('m-'+t).classList.remove('text-slate-400');
            },

            init: ()=>{
                // Snapshot: Transactions (No-Index JS Sort)
                onSnapshot(collection(db,"transactions"), s=>{
                    allTx = []; let p=0, daily=0;
                    s.forEach(d=>{ 
                        const x=d.data(); x.id=d.id; allTx.push(x); 
                        if(x.status==='pending') p++;
                        if(x.status==='completed' && moment(x.timestamp?.seconds*1000).isSame(moment(), 'day') && x.type==='deposit') daily += x.amount;
                    });
                    allTx.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    document.getElementById('stPen').innerText = p;
                    document.getElementById('stDaily').innerText = '‡∏ø'+daily.toLocaleString();
                    document.getElementById('badge').innerText = p; document.getElementById('badge').classList.toggle('hidden', p===0);
                    adm.renderReq(allTx.filter(x=>x.status==='pending'));
                    adm.renderLogs(allTx.slice(0, 10));
                });

                // Snapshot: Users
                onSnapshot(collection(db,"users"), s=>{
                    allUsers=[]; let bal=0; 
                    s.forEach(d=>{ const u=d.data(); allUsers.push(u); if(u.role!=='admin') bal += Number(u.balance || 0); });
                    document.getElementById('stUsr').innerText = allUsers.length; 
                    document.getElementById('stBal').innerText = bal.toLocaleString();
                    adm.renderUsers(allUsers);
                });

                // Snapshot: System Config
                onSnapshot(doc(db,"system","config"), s=>{
                    if(s.exists()){
                        sysConfig = s.data();
                        document.getElementById('cfgBank').value = sysConfig.adminBank || '';
                        document.getElementById('cfgWalletAcc').value = sysConfig.adminWallet || '';
                        document.getElementById('cfgWalletFee').value = sysConfig.walletFee || 0;
                        document.getElementById('cfgWithdrawFee').value = sysConfig.feePercent || 0;
                        document.getElementById('cfgLink').value = sysConfig.contactLink || '';
                        adm.renderBankToggles();
                    }
                });

                // Snapshot: Notice
                onSnapshot(doc(db,"announcements","main"), s => { if(s.exists()) document.getElementById('admNotice').value = s.data().content; });
            },

            // --- Req Master ---
            renderReq: (list)=>{
                const t=document.getElementById('tbReq'); t.innerHTML='';
                document.getElementById('noReq').classList.toggle('hidden', list.length > 0);
                list.forEach(x=>{
                    const isD = x.type==='deposit';
                    t.innerHTML+=`<tr class="hover:bg-slate-900/40 transition">
                        <td class="p-6">
                            <div class="font-black text-white text-xs uppercase leading-none mb-2">${x.userDisplayName || 'Guest'}</div>
                            <div class="text-[8px] text-slate-600 font-bold uppercase tracking-widest">${x.email || '-'}</div>
                        </td>
                        <td class="p-6">
                            <span class="status-badge ${isD?'bg-success/10 text-success border border-success/20':'bg-warning/10 text-warning border border-warning/20'} border">
                                ${x.type} (${x.method||'bank'})
                            </span>
                            <div class="text-[8px] text-slate-700 mt-2 font-black uppercase italic">${x.userBank || '-'}</div>
                        </td>
                        <td class="p-6 text-right font-black text-white text-lg italic font-display">‡∏ø${x.amount.toLocaleString()}</td>
                        <td class="p-6 text-center">
                            <div class="flex justify-center gap-2">
                                <button onclick="adm.proc('${x.id}','approve')" class="w-9 h-9 bg-success/10 text-success rounded-xl hover:bg-success hover:text-adm transition-all border border-success/10"><i class="fas fa-check text-xs"></i></button>
                                <button onclick="adm.proc('${x.id}','reject')" class="w-9 h-9 bg-danger/10 text-danger rounded-xl hover:bg-danger hover:text-white transition-all border border-danger/10"><i class="fas fa-times text-xs"></i></button>
                            </div>
                        </td>
                    </tr>`;
                });
            },

            proc: async(id,act)=>{
                const res = await Swal.fire({ title: 'Confirm Operation?', icon: 'question', showCancelButton: true, background: '#020617', color: '#fff', confirmButtonColor: act==='approve'?'#10b981':'#f43f5e' });
                if(res.isConfirmed){
                    try {
                        await runTransaction(db, async(t)=>{
                            const trDoc = await t.get(doc(db,"transactions",id));
                            const tx = trDoc.data();
                            const userRef = doc(db,"users",tx.uid);
                            const uSnap = await t.get(userRef);
                            const currentBal = Number(uSnap.data().balance || 0);

                            if(act==='approve'){
                                t.update(userRef, { balance: tx.type==='deposit' ? currentBal + Number(tx.amount) : currentBal });
                                t.update(doc(db,"transactions",id), { status: 'completed' });
                            } else {
                                if(tx.type==='withdraw') t.update(userRef, { balance: currentBal + Number(tx.amount) });
                                t.update(doc(db,"transactions",id), { status: 'rejected' });
                            }
                        });
                        Swal.fire({ icon:'success', title:'Executed', background: '#020617', color: '#fff' });
                    } catch(e){ Swal.fire('Error', e.message, 'error'); }
                }
            },

            // --- User Matrix ---
            renderUsers: (list)=>{
                const g=document.getElementById('grUsr'); g.innerHTML='';
                list.forEach(u=>{
                    g.innerHTML+=`<div class="glass p-7 rounded-[2.5rem] border border-slate-900 group hover:border-brand/30 transition-all">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-11 h-11 rounded-2xl bg-adm border border-slate-800 overflow-hidden shadow-inner flex items-center justify-center">
                                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${u.uid}" class="w-full h-full">
                            </div>
                            <div class="overflow-hidden">
                                <p class="font-black text-white text-xs leading-none italic uppercase tracking-tighter">${u.displayName || 'No Name'}</p>
                                <p class="text-[8px] text-slate-600 font-bold mt-2 uppercase tracking-widest truncate w-32">${u.email}</p>
                            </div>
                        </div>
                        <div class="bg-adm/50 p-4 rounded-2xl space-y-2 mb-6 text-[9px] font-bold">
                            <p class="flex justify-between"><span>BANK:</span> <span class="text-brand uppercase">${u.bankName || '-'}</span></p>
                            <p class="flex justify-between text-slate-500"><span>ACCOUNT:</span> <span>${u.bankAcc || '-'}</span></p>
                        </div>
                        <div class="flex justify-between items-end border-t border-slate-900 pt-5">
                            <div>
                                <p class="text-[8px] font-black text-slate-600 uppercase mb-2">Verified Balance</p>
                                <p class="text-2xl font-black text-white font-display italic leading-none">‡∏ø${Number(u.balance || 0).toLocaleString()}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="adm.adjust('${u.uid}','add')" class="w-8 h-8 bg-success/10 text-success rounded-lg hover:bg-success hover:text-adm transition shadow-lg flex items-center justify-center border border-success/10"><i class="fas fa-plus text-[10px]"></i></button>
                                <button onclick="adm.adjust('${u.uid}','deduct')" class="w-8 h-8 bg-danger/10 text-danger rounded-lg hover:bg-danger hover:text-white transition shadow-lg flex items-center justify-center border border-danger/10"><i class="fas fa-minus text-[10px]"></i></button>
                            </div>
                        </div>
                    </div>`;
                });
            },

            adjust: async(uid, mode)=>{
                const { value: f } = await Swal.fire({
                    title: mode==='add' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï' : '‡∏´‡∏±‡∏Å‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å', background: '#020617', color: '#fff',
                    html: '<div class="space-y-4"><input id="a-a" type="number" class="swal2-input text-center" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)"><textarea id="a-r" class="swal2-textarea" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ)"></textarea></div>',
                    preConfirm: () => [Number(document.getElementById('a-a').value), document.getElementById('a-r').value]
                });
                if(f && f[0] > 0){
                    Swal.showLoading();
                    await runTransaction(db, async(t)=>{
                        const uRef = doc(db,"users",uid); const uSnap = await t.get(uRef);
                        let nb = mode === 'add' ? Number(uSnap.data().balance || 0) + f[0] : Number(uSnap.data().balance || 0) - f[0];
                        t.update(uRef, { balance: nb });
                        t.set(doc(collection(db,"transactions")), { uid, type:'adjustment', amount: f[0], status: 'completed', timestamp: serverTimestamp(), userDisplayName: uSnap.data().displayName, reason: f[1] || 'Manual Protocol Adjustment' });
                    });
                    Swal.fire({ icon:'success', title:'Balances Synced', background: '#020617', color: '#fff', timer:1500 });
                }
            },

            // --- Configuration Logic ---
            renderBankToggles: () => {
                const list = document.getElementById('bankToggleList'); list.innerHTML = '';
                const activeOnes = sysConfig.activeBanks || [];
                Object.entries(BANK_MASTER).forEach(([key, val]) => {
                    const isActive = activeOnes.includes(key);
                    list.innerHTML += `
                        <div onclick="adm.toggleBank('${key}')" class="bank-card p-5 rounded-2xl flex flex-col items-center gap-3 transition-all ${isActive?'active':''}">
                            <img src="${val.icon}" class="w-8 h-8 object-contain">
                            <span class="text-[10px] font-black uppercase text-slate-500">${val.name}</span>
                        </div>`;
                });
            },

            toggleBank: async(key) => {
                let activeOnes = sysConfig.activeBanks || [];
                if(activeOnes.includes(key)) activeOnes = activeOnes.filter(k => k !== key); else activeOnes.push(key);
                await updateDoc(doc(db,"system","config"), { activeBanks: activeOnes });
            },

            saveFinance: async() => {
                Swal.showLoading();
                await setDoc(doc(db,"system","config"), {
                    adminBank: document.getElementById('cfgBank').value,
                    adminWallet: document.getElementById('cfgWalletAcc').value,
                    walletFee: Number(document.getElementById('cfgWalletFee').value),
                    feePercent: Number(document.getElementById('cfgWithdrawFee').value),
                    contactLink: document.getElementById('cfgLink').value
                }, {merge:true});
                Swal.fire({ icon:'success', title:'Config Updated', background: '#020617', color: '#fff' });
            },

            saveNotice: async() => {
                Swal.showLoading();
                await setDoc(doc(db,"announcements", "main"), { content: document.getElementById('admNotice').value, title: 'ADMIN', updatedAt: serverTimestamp() });
                Swal.fire({ icon:'success', title:'Announcement Broadcasted', background: '#020617', color: '#fff' });
            },

            renderLogs: (list)=>{
                const el = document.getElementById('recentLogs'); el.innerHTML = '';
                list.forEach(x => {
                    const isD = x.type==='deposit' || (x.type==='adjustment' && x.amount > 0);
                    el.innerHTML += `<div class="flex justify-between items-center bg-adm/40 p-4 rounded-2xl border border-slate-900 group hover:border-brand/30 transition-all leading-none">
                        <div class="flex items-center gap-4"><span class="text-slate-700 uppercase font-black text-[9px] tracking-widest">${moment(x.timestamp?.seconds*1000).format('HH:mm')}</span><span class="font-bold text-white uppercase text-[11px] truncate w-24">${x.userDisplayName || 'User'}</span></div>
                        <div class="flex gap-6 items-center"><span class="${isD?'text-success':'text-danger'} font-black font-display italic text-xs">‡∏ø${x.amount.toLocaleString()}</span><span class="text-slate-800 font-black uppercase text-[7px] tracking-widest">${x.status}</span></div>
                    </div>`;
                });
            },

            searchU: (k)=>adm.renderUsers(allUsers.filter(u=>(u.displayName||'').toLowerCase().includes(k.toLowerCase())||(u.email||'').toLowerCase().includes(k.toLowerCase()))),
            logout: ()=>signOut(auth).then(()=>location.reload()),
            tab: (t)=>{ adm.tab(t); }, // Stub for direct call
            filterReq: (type)=>{ 
                if(type==='all') adm.renderReq(allTx.filter(x=>x.status==='pending'));
                else adm.renderReq(allTx.filter(x=>x.status==='pending' && x.type===type));
            }
        };

        // Redefining tab function for scope
        window.adm.tab = (t)=>{
            document.querySelectorAll('[id^="t-"]').forEach(e=>e.classList.add('hidden')); 
            document.getElementById('t-'+t).classList.remove('hidden'); 
            document.querySelectorAll('[id^="m-"]').forEach(e=>e.classList.remove('nav-active'));
            document.querySelectorAll('[id^="m-"]').forEach(e=>e.classList.add('text-slate-400'));
            document.getElementById('m-'+t).classList.add('nav-active'); 
            document.getElementById('m-'+t).classList.remove('text-slate-400');
        };

    </script>
</body>
</html>
