<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITANIUM - GOD MODE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;600&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>body{background:#020617;color:#cbd5e1;font-family:'Kanit'} .card{background:#0f172a;border:1px solid #1e293b;padding:20px;border-radius:12px} input{background:#020617;border:1px solid #334155;color:white;padding:8px;border-radius:6px;width:100%;outline:none} input:focus{border-color:#eab308}</style>
</head>
<body class="p-6">

    <div id="auth" class="flex items-center justify-center h-screen bg-black z-[100] relative">
        <div class="card w-[400px] text-center border-t-4 border-[#eab308]">
            <h2 class="text-2xl font-bold text-[#eab308] mb-8 uppercase">Security Gateway</h2>
            <input id="a-user" class="mb-4 text-center" value="farisxuma1@gmail.com" readonly>
            <input id="a-pass" type="password" class="mb-8 text-center" placeholder="Access Code">
            <button onclick="Admin.login()" class="w-full bg-[#eab308] text-black font-bold py-4 rounded-xl">LOGIN</button>
        </div>
    </div>

    <div id="panel" class="hidden">
        <aside class="fixed left-0 top-0 w-64 h-full bg-black border-r border-white/10 p-6">
            <h1 class="text-2xl font-bold text-[#eab308] mb-8">ADMIN</h1>
            <nav class="space-y-2">
                <button onclick="UI.tab('monitor')" class="w-full text-left p-3 rounded hover:bg-white/5 text-sm font-bold">üì° Live Monitor</button>
                <button onclick="UI.tab('rooms')" class="w-full text-left p-3 rounded hover:bg-white/5 text-sm font-bold">üéÆ Create Room</button>
                <button onclick="UI.tab('finance')" class="w-full text-left p-3 rounded hover:bg-white/5 text-sm font-bold">üí∏ Finance</button>
                <button onclick="UI.tab('users')" class="w-full text-left p-3 rounded hover:bg-white/5 text-sm font-bold">üë• Users & Penalty</button>
                <button onclick="UI.tab('settings')" class="w-full text-left p-3 rounded hover:bg-white/5 text-sm font-bold">‚öôÔ∏è System Config</button>
            </nav>
        </aside>

        <main class="ml-64 p-8">
            <section id="p-monitor">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white">Live Monitor</h2>
                    <div class="text-xs text-green-500 font-bold bg-green-900/20 px-3 py-1 rounded border border-green-500/30 animate-pulse">‚óè SERVER RUNNING</div>
                </div>
                <div id="monitor-list" class="grid grid-cols-2 gap-4"></div>
            </section>

            <section id="p-rooms" class="hidden max-w-xl">
                <h2 class="text-2xl font-bold text-white mb-6">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á</h2>
                <div class="card space-y-4">
                    <input id="r-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á">
                    <input id="r-bet" type="number" placeholder="‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô">
                    <select id="r-type" class="w-full bg-[#020617] text-white p-2 rounded border border-[#334155]"><option value="rps">‡πÄ‡∏õ‡πà‡∏≤‡∏¢‡∏¥‡πâ‡∏á‡∏â‡∏∏‡∏ö</option><option value="pokdeng">‡∏õ‡πä‡∏≠‡∏Å‡πÄ‡∏î‡πâ‡∏á</option></select>
                    <select id="r-rig" class="w-full bg-[#020617] text-white p-2 rounded border border-[#334155]"><option value="">-- ‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Ñ --</option><option value="p1">‡∏•‡πá‡∏≠‡∏Ñ P1 ‡∏ä‡∏ô‡∏∞</option><option value="p2">‡∏•‡πá‡∏≠‡∏Ñ P2 ‡∏ä‡∏ô‡∏∞</option></select>
                    <button onclick="Admin.create()" class="w-full bg-green-600 text-white font-bold py-3 rounded">‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
                </div>
            </section>

            <section id="p-finance" class="hidden">
                <h2 class="text-2xl font-bold text-white mb-6">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h2>
                <div id="tx-list" class="grid grid-cols-2 gap-4"></div>
            </section>

            <section id="p-users" class="hidden">
                <div class="flex justify-between mb-6">
                    <h2 class="text-2xl font-bold text-white">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
                    <input onkeyup="Admin.filter(this.value)" class="w-64" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
                </div>
                <div id="user-list" class="space-y-2"></div>
            </section>

            <section id="p-settings" class="hidden max-w-2xl space-y-6">
                <div class="card">
                    <h3 class="font-bold text-[#eab308] mb-4">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h3>
                    <input id="s-ann" class="mb-2" placeholder="‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®">
                    <div class="flex gap-4 p-4 bg-black/40 rounded-lg">
                        <label class="flex items-center gap-2"><input type="checkbox" id="s-dep"> ‡πÄ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤‡∏Å</label>
                        <label class="flex items-center gap-2"><input type="checkbox" id="s-wit"> ‡πÄ‡∏õ‡∏¥‡∏î‡∏ñ‡∏≠‡∏ô</label>
                    </div>
                    <label class="text-xs text-gray-500 mt-2 block">‡∏Ñ‡∏∑‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏™‡∏µ‡∏¢ (%)</label>
                    <input id="s-cb" type="number" class="mt-1 w-20">
                    <button onclick="Admin.saveSet()" class="bg-[#eab308] text-black px-4 py-1 rounded mt-4 text-xs font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
                <div class="card">
                    <h3 class="font-bold text-blue-500 mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</h3>
                    <div class="flex gap-2"><input id="b-name" placeholder="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£"><input id="b-acc" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ"></div>
                    <button onclick="Admin.addBank()" class="bg-blue-600 px-4 py-1 rounded mt-2 text-white text-xs">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    <div id="bank-list" class="mt-2 text-xs space-y-1"></div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDc50wlOejDQi3PTySiQss3bLuVz_-tvB4", authDomain: "walletrs-d6104.firebaseapp.com", projectId: "walletrs-d6104", storageBucket: "walletrs-d6104.firebasestorage.app", messagingSenderId: "496661515180", appId: "1:496661515180:web:42c3a21541cdfc68cf8809", measurementId: "G-2P8SGLR602", databaseURL: "https://walletrs-d6104-default-rtdb.asia-southeast1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database(), auth = firebase.auth();

        // --- GAME SERVER LOGIC ---
        const Engine = {
            deck: [],
            initDeck: () => {
                Engine.deck=[]; const s=['S','C','H','D'], r=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
                const v={'A':1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':0,'J':0,'Q':0,'K':0};
                s.forEach(suit=>r.forEach(rank=>Engine.deck.push({suit,rank,val:v[rank]})));
                Engine.deck.sort(()=>Math.random()-0.5);
            },
            score: (h) => {
                let s = h.reduce((a,b)=>a+b.val,0)%10;
                let pok = h.length===2 && (s===8||s===9);
                return {score:s, pok:pok};
            },
            run: () => {
                db.ref('rooms').once('value', s => {
                    s.forEach(doc => {
                        const r = doc.val(), k = doc.key;
                        
                        // 1. Start Game
                        if(r.status==='waiting_ready' && r.p1.ready && r.p2.ready) {
                            if(r.type==='rps') db.ref(`rooms/${k}`).update({status:'playing', turnStartTime:Date.now()});
                            else if(r.type==='pokdeng') {
                                Engine.initDeck(); let d = Engine.deck; let h1=[], h2=[];
                                // Rigging
                                if(r.rig==='p1') { h1=[{rank:'9',val:9,suit:'D'},{rank:'K',val:0,suit:'S'}]; h2=[{rank:'2',val:2,suit:'C'},{rank:'3',val:3,suit:'H'}]; }
                                else if(r.rig==='p2') { h2=[{rank:'9',val:9,suit:'D'},{rank:'K',val:0,suit:'S'}]; h1=[{rank:'2',val:2,suit:'C'},{rank:'3',val:3,suit:'H'}]; }
                                else { h1=[d.pop(),d.pop()]; h2=[d.pop(),d.pop()]; }

                                const s1=Engine.score(h1), s2=Engine.score(h2);
                                
                                if(s1.pok || s2.pok) {
                                    let w='draw';
                                    if(s1.pok && !s2.pok) w=r.p1.uid;
                                    else if(!s1.pok && s2.pok) w=r.p2.uid;
                                    else if(s1.score > s2.score) w=r.p1.uid;
                                    else if(s2.score > s1.score) w=r.p2.uid;
                                    
                                    db.ref(`rooms/${k}`).update({status:'finished', winner:w, 'p1/hand':h1, 'p2/hand':h2, 'p1/score':s1.score, 'p2/score':s2.score});
                                    Admin.payout(r, w);
                                } else {
                                    db.ref(`rooms/${k}`).update({status:'playing', stage:'action', turn:'p1', 'p1/hand':h1, 'p2/hand':h2, 'p1/score':s1.score, 'p2/score':s2.score, deck:d});
                                }
                            }
                        }

                        // 2. RPS Logic
                        if(r.type==='rps' && r.status==='playing') {
                            const elap = (Date.now() - r.turnStartTime)/1000;
                            if(elap > 10 && (!r.p1.move || !r.p2.move)) {
                                const m=['rock','paper','scissors'];
                                if(!r.p1.move) db.ref(`rooms/${k}/p1/move`).set(m[Math.floor(Math.random()*3)]);
                                if(!r.p2.move) db.ref(`rooms/${k}/p2/move`).set(m[Math.floor(Math.random()*3)]);
                            }
                            if(r.p1.move && r.p2.move) {
                                db.ref(`rooms/${k}/status`).set('calculating');
                                setTimeout(() => {
                                    const m1=r.p1.move, m2=r.p2.move;
                                    let w=0; 
                                    if(m1!==m2) { if((m1=='rock'&&m2=='scissors')||(m1=='paper'&&m2=='rock')||(m1=='scissors'&&m2=='paper')) w=1; else w=2; }
                                    const s1=r.p1.score+(w===1?1:0), s2=r.p2.score+(w===2?1:0);
                                    
                                    if(r.round < r.maxRound) db.ref(`rooms/${k}`).update({status:'waiting_ready', round:r.round+1, 'p1/move':'', 'p2/move':'', 'p1/ready':false, 'p2/ready':false, 'p1/score':s1, 'p2/score':s2});
                                    else {
                                        const fw = s1>s2?r.p1.uid:(s2>s1?r.p2.uid:'draw');
                                        db.ref(`rooms/${k}`).update({status:'finished', winner:fw, 'p1/score':s1, 'p2/score':s2});
                                        Admin.payout(r, fw);
                                    }
                                }, 2000);
                            }
                        }

                        // 3. Pokdeng Actions
                        if(r.type==='pokdeng' && r.status==='playing' && r.stage==='action' && r.actions) {
                            const acts = Object.values(r.actions);
                            if(acts.length >= 1) { // Simple Finish for Demo
                                let s1=Engine.score(r.p1.hand).score, s2=Engine.score(r.p2.hand).score;
                                let w='draw'; if(s1>s2) w=r.p1.uid; else if(s2>s1) w=r.p2.uid;
                                db.ref(`rooms/${k}`).update({status:'finished', winner:w, actions:null});
                                Admin.payout(r, w);
                            }
                        }
                    });
                });
            }
        };
        setInterval(Engine.run, 1000);

        const Admin = {
            login: () => { if(document.getElementById('a-pass').value=='admin') { document.getElementById('auth').style.display='none'; document.getElementById('panel').style.display='block'; Admin.init(); } },
            init: () => {
                db.ref('rooms').on('value', s => {
                    const l=document.getElementById('monitor-list'); l.innerHTML='';
                    s.forEach(d => {
                        const r=d.val();
                        l.innerHTML += `<div class="bg-black p-3 rounded border border-gray-700 relative text-xs"><b class="text-[#eab308]">${r.name}</b> (${r.status})<br>P1: ${r.p1?.name} | P2: ${r.p2?.name}<button onclick="db.ref('rooms/${d.key}').remove()" class="text-red-500 absolute top-2 right-2">DEL</button></div>`;
                    });
                });
                db.ref('transactions').orderByChild('status').equalTo('pending').on('value', s => {
                    const l=document.getElementById('tx-list'); l.innerHTML='';
                    s.forEach(d => {
                        const t=d.val();
                        l.innerHTML += `<div class="bg-black p-3 rounded border-l-4 ${t.type=='deposit'?'border-green-500':'border-red-500'} flex justify-between items-center"><div><b class="text-white">${t.type} ${t.amount}</b><br><span class="text-xs text-gray-500">${t.name}</span></div><div class="flex gap-2"><button onclick="Admin.tx('${d.key}','approved','${t.uid}',${t.amount},'${t.type}')" class="bg-green-600 px-2 rounded text-white text-xs">OK</button><button onclick="Admin.tx('${d.key}','rejected','${t.uid}',${t.amount},'${t.type}')" class="bg-red-600 px-2 rounded text-white text-xs">NO</button></div></div>`;
                    });
                });
                db.ref('users').on('value', s => {
                    const l=document.getElementById('user-list'); l.innerHTML='';
                    s.forEach(d => {
                        const u=d.val();
                        l.innerHTML += `<div class="bg-black p-3 rounded border border-gray-800 flex justify-between items-center user-item"><div><b class="text-[#eab308]">${u.name}</b><br><span class="text-xs text-gray-400">Balance: ${u.balance.toLocaleString()}</span></div><button onclick="Admin.penalty('${d.key}','${u.name}')" class="bg-red-900/50 text-red-400 px-3 py-1 rounded text-xs border border-red-500/20 hover:bg-red-600 hover:text-white">‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</button></div>`;
                    });
                });
                db.ref('settings').on('value', s => {
                    const c=s.val()||{}; document.getElementById('s-ann').value=c.announcement||'';
                    document.getElementById('s-dep').checked=c.isDepositActive; document.getElementById('s-wit').checked=c.isWithdrawActive;
                    document.getElementById('s-cb').value=c.cashbackPercent||5;
                    const bl=document.getElementById('bank-list'); bl.innerHTML='';
                    if(c.banks) Object.entries(c.banks).forEach(([k,v]) => bl.innerHTML+=`<div>${v.name}-${v.acc} <span onclick="db.ref('settings/banks/${k}').remove()" class="text-red-500 cursor-pointer">x</span></div>`);
                });
            },
            create: () => {
                const n=document.getElementById('r-name').value, b=Number(document.getElementById('r-bet').value);
                if(n&&b) db.ref('rooms').push({name:n, bet:b, type:document.getElementById('r-type').value, rig:document.getElementById('r-rig').value, maxRound:3, round:1, status:'open', created:Date.now()}).then(()=>Swal.fire('Created'));
            },
            tx: (k,s,u,a,t) => {
                db.ref('transactions/'+k).update({status:s});
                if(s=='approved') {
                    if(t=='deposit') db.ref('users/'+u).transaction(usr => { if(usr){usr.balance+=a; usr.total_dep=(usr.total_dep||0)+a;} return usr; });
                    if(t=='withdraw') db.ref('users/'+u).transaction(usr => { if(usr){usr.total_wit=(usr.total_wit||0)+a;} return usr; });
                }
                if(s=='rejected' && t=='withdraw') db.ref('users/'+u+'/balance').transaction(b=>b+a);
            },
            payout: (r, w) => {
                if(w==='draw') {
                    db.ref('users/'+r.p1.uid+'/balance').transaction(b=>b+r.bet);
                    db.ref('users/'+r.p2.uid+'/balance').transaction(b=>b+r.bet);
                } else {
                    db.ref('users/'+w+'/balance').transaction(b=>b+r.bet*2);
                }
            },
            addBank: () => db.ref('settings/banks').push({name:document.getElementById('b-name').value, acc:document.getElementById('b-acc').value}),
            saveSet: () => db.ref('settings').update({announcement:document.getElementById('s-ann').value, isDepositActive:document.getElementById('s-dep').checked, isWithdrawActive:document.getElementById('s-wit').checked, cashbackPercent:Number(document.getElementById('s-cb').value)}),
            penalty: async (uid, name) => {
                const {value:form} = await Swal.fire({title:`‡∏•‡∏á‡πÇ‡∏ó‡∏© ${name}`, html:'<input id="p-amt" class="swal2-input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"><input id="p-reason" class="swal2-input" placeholder="‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏">', focusConfirm:false, preConfirm:()=>[document.getElementById('p-amt').value, document.getElementById('p-reason').value]});
                if(form && form[0]) {
                    const amt=Number(form[0]);
                    db.ref('users/'+uid+'/balance').transaction(b=>b-amt);
                    db.ref('transactions').push({uid:uid, type:'penalty', amount:amt, reason:form[1], status:'completed', timestamp:Date.now()});
                    Swal.fire('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                }
            },
            filter: (v) => document.querySelectorAll('.user-item').forEach(el=>el.style.display=el.innerText.toLowerCase().includes(v.toLowerCase())?'flex':'none')
        };
        const UI = { route: (p) => { ['monitor','rooms','finance','users','settings'].forEach(id=>document.getElementById('p-'+id).classList.add('hidden')); document.getElementById('p-'+p).classList.remove('hidden'); }, tab: (p) => UI.route(p) };
    </script>
</body>
</html>
