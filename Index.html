<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RS INFINITY - ADMIN CONSOLE</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gold: '#D4AF37',
                        'gold-dark': '#A67C00',
                        dark: '#0f0f0f',
                        glass: 'rgba(30, 30, 30, 0.9)',
                    },
                    fontFamily: {
                        sans: ['Kanit', 'sans-serif'],
                        tech: ['Rajdhani', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #050505;
            color: #e5e5e5;
        }
        .glass-panel {
            background: #121212;
            border: 1px solid #333;
        }
        .nav-item.active {
            background: rgba(212, 175, 55, 0.1);
            color: #D4AF37;
            border-right: 3px solid #D4AF37;
        }
        /* Table Styles */
        .custom-table th { text-align: left; padding: 12px; color: #888; font-size: 0.8rem; text-transform: uppercase; border-bottom: 1px solid #333; }
        .custom-table td { padding: 16px 12px; border-bottom: 1px solid #222; }
        .custom-table tr:hover { background-color: #1a1a1a; }
        
        .status-active { color: #4ade80; background: rgba(74, 222, 128, 0.1); padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .status-expired { color: #f87171; background: rgba(248, 113, 113, 0.1); padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <div id="admin-login" class="fixed inset-0 z-50 bg-black flex items-center justify-center">
        <div class="w-full max-w-md p-8 glass-panel rounded-2xl border border-gold/30">
            <h1 class="text-3xl font-bold text-center mb-2 text-gold tracking-widest font-tech">ADMIN ACCESS</h1>
            <p class="text-center text-gray-500 text-sm mb-6">RS Infinity Command Center</p>
            <form id="login-form" class="space-y-4">
                <input type="email" id="adm-email" placeholder="Admin Email" class="w-full bg-black/50 border border-gray-700 p-3 rounded text-white focus:border-gold outline-none">
                <input type="password" id="adm-pass" placeholder="Password" class="w-full bg-black/50 border border-gray-700 p-3 rounded text-white focus:border-gold outline-none">
                <button type="submit" class="w-full bg-gold text-black font-bold py-3 rounded hover:bg-gold-dark transition">LOGIN</button>
            </form>
        </div>
    </div>

    <aside class="w-64 bg-[#0a0a0a] border-r border-gray-800 flex flex-col hidden" id="sidebar">
        <div class="p-6 flex items-center gap-3">
            <i class="fa-solid fa-shield-cat text-gold text-2xl"></i>
            <div>
                <div class="font-bold text-lg text-white font-tech tracking-wide">RS ADMIN</div>
                <div class="text-[10px] text-gray-500">System Manager</div>
            </div>
        </div>
        
        <nav class="flex-1 mt-4">
            <a href="#" onclick="showPage('dashboard')" id="menu-dashboard" class="nav-item active flex items-center gap-3 px-6 py-4 text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-chart-line w-5"></i> Dashboard
            </a>
            <a href="#" onclick="showPage('users')" id="menu-users" class="nav-item flex items-center gap-3 px-6 py-4 text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-users w-5"></i> จัดการสมาชิก
            </a>
            <a href="#" onclick="showPage('settings')" id="menu-settings" class="nav-item flex items-center gap-3 px-6 py-4 text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-sliders w-5"></i> ตั้งค่าระบบ
            </a>
        </nav>

        <div class="p-4 border-t border-gray-800">
            <button onclick="logout()" class="w-full flex items-center justify-center gap-2 text-red-500 p-2 hover:bg-red-900/10 rounded transition">
                <i class="fa-solid fa-right-from-bracket"></i> ออกจากระบบ
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative hidden" id="main-content">
        <header class="h-16 border-b border-gray-800 flex justify-between items-center px-8 bg-[#0a0a0a]">
            <h2 id="page-title" class="text-xl font-bold text-gold font-tech">DASHBOARD OVERVIEW</h2>
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-xs text-gray-400">System Online</span>
            </div>
        </header>

        <div class="flex-1 overflow-auto p-8">
            
            <div id="page-dashboard" class="space-y-6 animate-fade">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="glass-panel p-6 rounded-xl border-l-4 border-gold">
                        <div class="text-gray-400 text-sm mb-1">สมาชิกทั้งหมด (Total Users)</div>
                        <div id="stat-total" class="text-4xl font-bold font-tech text-white">0</div>
                    </div>
                    <div class="glass-panel p-6 rounded-xl border-l-4 border-green-500">
                        <div class="text-gray-400 text-sm mb-1">ใช้งานได้ (Active)</div>
                        <div id="stat-active" class="text-4xl font-bold font-tech text-green-400">0</div>
                    </div>
                    <div class="glass-panel p-6 rounded-xl border-l-4 border-red-500">
                        <div class="text-gray-400 text-sm mb-1">หมดอายุ (Expired)</div>
                        <div id="stat-expired" class="text-4xl font-bold font-tech text-red-400">0</div>
                    </div>
                </div>
            </div>

            <div id="page-users" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <div class="relative w-64">
                        <i class="fa-solid fa-search absolute left-3 top-3 text-gray-500"></i>
                        <input type="text" id="search-input" placeholder="ค้นหา Email..." class="w-full bg-[#1a1a1a] border border-gray-700 rounded-lg pl-10 pr-4 py-2 text-white focus:border-gold outline-none">
                    </div>
                    <button onclick="refreshUsers()" class="p-2 text-gold hover:bg-gray-800 rounded"><i class="fa-solid fa-rotate"></i> Refresh</button>
                </div>

                <div class="glass-panel rounded-xl overflow-hidden">
                    <table class="w-full custom-table text-sm">
                        <thead>
                            <tr>
                                <th>Email / UID</th>
                                <th>Package</th>
                                <th>Expire Date</th>
                                <th>Status</th>
                                <th class="text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="page-settings" class="hidden max-w-2xl mx-auto">
                <div class="glass-panel p-8 rounded-xl border border-gray-700">
                    <h3 class="text-xl font-bold mb-6 text-white border-b border-gray-700 pb-4">ตั้งค่าการติดต่อ (Contact Config)</h3>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2"><i class="fa-brands fa-line text-green-500 mr-2"></i>LINE Official Link</label>
                            <input type="text" id="conf-line" class="w-full bg-black/50 border border-gray-600 rounded p-3 text-white focus:border-green-500 outline-none" placeholder="https://line.me/...">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2"><i class="fa-brands fa-facebook text-blue-500 mr-2"></i>Facebook Page Link</label>
                            <input type="text" id="conf-fb" class="w-full bg-black/50 border border-gray-600 rounded p-3 text-white focus:border-blue-500 outline-none" placeholder="https://facebook.com/...">
                        </div>
                        <button onclick="saveConfig()" class="w-full bg-gold hover:bg-gold-dark text-black font-bold py-3 rounded transition shadow-lg shadow-gold/20">
                            บันทึกข้อมูล (SAVE CONFIG)
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, setDoc, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // FIREBASE CONFIG (SAME AS USER APP)
        const firebaseConfig = {
            apiKey: "AIzaSyBNfTBQthLLRbJP9BXZ-UQptFsdU324Mv0",
            authDomain: "fafada-d9899.firebaseapp.com",
            projectId: "fafada-d9899",
            storageBucket: "fafada-d9899.appspot.com",
            messagingSenderId: "484777586908",
            appId: "1:484777586908:web:16a8f0367ad15737364419"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // STATE
        let allUsers = [];

        // --- AUTH ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('admin-login').style.display = 'none';
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                initAdmin();
            } else {
                document.getElementById('admin-login').style.display = 'flex';
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('main-content').classList.add('hidden');
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('adm-email').value;
            const pass = document.getElementById('adm-pass').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
                // Note: In real production, check if user.uid is in 'admins' collection
            } catch (err) {
                Swal.fire('Login Failed', err.message, 'error');
            }
        });

        window.logout = () => signOut(auth);

        // --- MAIN LOGIC ---
        function initAdmin() {
            // Listen to Users Collection Realtime
            onSnapshot(collection(db, "users"), (snapshot) => {
                allUsers = [];
                let activeCount = 0;
                let expiredCount = 0;
                const now = new Date();

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const expiry = data.expiryDate ? data.expiryDate.toDate() : new Date(0);
                    const isActive = expiry > now;
                    
                    if (isActive) activeCount++; else expiredCount++;

                    allUsers.push({
                        id: doc.id,
                        ...data,
                        expiryObj: expiry,
                        isActive
                    });
                });

                // Update Stats
                document.getElementById('stat-total').innerText = allUsers.length;
                document.getElementById('stat-active').innerText = activeCount;
                document.getElementById('stat-expired').innerText = expiredCount;

                // Render Table
                renderTable(allUsers);
            });

            // Load Config
            onSnapshot(doc(db, "system", "config"), (docSnap) => {
                if (docSnap.exists()) {
                    const d = docSnap.data();
                    document.getElementById('conf-line').value = d.lineLink || '';
                    document.getElementById('conf-fb').value = d.facebookLink || '';
                }
            });
        }

        // --- TABLE & ACTIONS ---
        function renderTable(users) {
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = '';

            users.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="font-bold text-white">${u.email}</div>
                        <div class="text-[10px] text-gray-500 font-mono">${u.id}</div>
                    </td>
                    <td>
                        <span class="text-gold text-xs border border-gold/30 px-2 py-1 rounded">${u.packageType || 'FREE'}</span>
                    </td>
                    <td>
                        <div class="text-gray-300 font-tech">${u.expiryObj.toLocaleString('th-TH')}</div>
                    </td>
                    <td>
                        <span class="${u.isActive ? 'status-active' : 'status-expired'}">
                            ${u.isActive ? 'ACTIVE' : 'EXPIRED'}
                        </span>
                    </td>
                    <td class="text-right space-x-2">
                        <button onclick="addDays('${u.id}', '${u.email}')" class="bg-gray-800 hover:bg-green-900 text-green-500 px-3 py-1 rounded text-xs transition border border-gray-700" title="Add Time">
                            <i class="fa-solid fa-clock-rotate-left"></i> เติมวัน
                        </button>
                         <button onclick="editUser('${u.id}', '${u.packageType || ''}')" class="bg-gray-800 hover:bg-blue-900 text-blue-500 px-3 py-1 rounded text-xs transition border border-gray-700" title="Edit Package">
                            <i class="fa-solid fa-pen"></i> แก้ไข
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Search
        document.getElementById('search-input').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allUsers.filter(u => u.email.toLowerCase().includes(term) || u.id.includes(term));
            renderTable(filtered);
        });

        // --- ACTIONS ---
        window.addDays = async (uid, email) => {
            const { value: days } = await Swal.fire({
                title: 'เติมวันใช้งาน',
                html: `User: <span class="text-gold">${email}</span><br>เลือกจำนวนวันที่ต้องการเพิ่ม:`,
                input: 'select',
                inputOptions: {
                    '7': '7 วัน (Trial)',
                    '30': '30 วัน (1 เดือน)',
                    '90': '90 วัน (3 เดือน)',
                    '365': '365 วัน (1 ปี)'
                },
                inputPlaceholder: 'เลือกจำนวนวัน',
                showCancelButton: true,
                background: '#1a1a1a', color: '#fff'
            });

            if (days) {
                const user = allUsers.find(u => u.id === uid);
                // If expired, start from now. If active, add to existing.
                let baseDate = user.isActive ? user.expiryObj : new Date();
                let newDate = new Date(baseDate.getTime() + (parseInt(days) * 24 * 60 * 60 * 1000));

                try {
                    await updateDoc(doc(db, "users", uid), { expiryDate: newDate });
                    Swal.fire({icon: 'success', title: 'เติมวันสำเร็จ!', text: `หมดอายุ: ${newDate.toLocaleString()}`, background: '#1a1a1a', color: '#fff'});
                } catch(e) { Swal.fire('Error', e.message, 'error'); }
            }
        };

        window.editUser = async (uid, currentPack) => {
            const { value: pack } = await Swal.fire({
                title: 'เปลี่ยนแพ็กเกจ',
                input: 'select',
                inputOptions: {
                    'FREE MEMBER': 'Free Member',
                    'VIP TRADER': 'VIP TRADER',
                    'VVIP DIRECTOR': 'VVIP DIRECTOR'
                },
                inputValue: currentPack,
                showCancelButton: true,
                background: '#1a1a1a', color: '#fff'
            });

            if (pack) {
                try {
                    await updateDoc(doc(db, "users", uid), { packageType: pack });
                    Swal.fire({icon: 'success', title: 'บันทึกสำเร็จ', background: '#1a1a1a', color: '#fff'});
                } catch(e) { Swal.fire('Error', e.message, 'error'); }
            }
        };

        // --- CONFIG ---
        window.saveConfig = async () => {
            const line = document.getElementById('conf-line').value;
            const fb = document.getElementById('conf-fb').value;
            
            try {
                await setDoc(doc(db, "system", "config"), {
                    lineLink: line,
                    facebookLink: fb
                }, { merge: true });
                Swal.fire({icon: 'success', title: 'บันทึกการตั้งค่าแล้ว', background: '#1a1a1a', color: '#fff'});
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        };

        // --- NAVIGATION ---
        window.showPage = (page) => {
            document.querySelectorAll('[id^="page-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById('page-' + page).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active', 'text-white'));
            document.getElementById('menu-' + page).classList.add('active', 'text-white');
            
            const titles = { 'dashboard': 'DASHBOARD OVERVIEW', 'users': 'USER MANAGEMENT', 'settings': 'SYSTEM SETTINGS' };
            document.getElementById('page-title').innerText = titles[page];
        };

        window.refreshUsers = () => { /* Handled by snapshot listener automatically */ };
    </script>
</body>
</html>
