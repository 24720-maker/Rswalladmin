<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAFADA - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style> body { font-family: 'Prompt', sans-serif; } </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex">

    <aside class="w-64 bg-slate-800 border-r border-slate-700 flex flex-col fixed h-full">
        <div class="h-16 flex items-center justify-center border-b border-slate-700 bg-slate-900">
            <span class="text-yellow-500 font-bold text-xl tracking-widest">FAFADA ADMIN</span>
        </div>
        <div class="flex-1 p-4 space-y-2">
            <button onclick="switchTab('dashboard')" id="menuDash" class="w-full text-left px-4 py-3 rounded bg-blue-600 text-white"><i class="fas fa-list mr-2"></i> รายการรออนุมัติ</button>
            <button onclick="switchTab('users')" id="menuUsers" class="w-full text-left px-4 py-3 rounded text-slate-400 hover:bg-slate-700"><i class="fas fa-users mr-2"></i> จัดการสมาชิก</button>
            <button onclick="switchTab('news')" id="menuNews" class="w-full text-left px-4 py-3 rounded text-slate-400 hover:bg-slate-700"><i class="fas fa-bullhorn mr-2"></i> ประกาศข่าว</button>
        </div>
        <div class="p-4 border-t border-slate-700">
             <div class="mb-2 text-sm text-slate-400">เข้าสู่ระบบโดย:</div>
             <div id="adminEmail" class="text-sm font-bold truncate mb-4">...</div>
             <button onclick="handleLogout()" class="w-full border border-red-500 text-red-500 py-2 rounded hover:bg-red-500 hover:text-white transition">ออกจากระบบ</button>
        </div>
    </aside>

    <main class="ml-64 flex-1 p-8">
        
        <div id="tabDashboard">
            <h2 class="text-2xl font-bold mb-6 flex items-center"><i class="fas fa-clock text-yellow-500 mr-2"></i> รายการรอตรวจสอบ (Pending)</h2>
            <div class="bg-slate-800 rounded-lg overflow-hidden border border-slate-700">
                <table class="w-full text-left">
                    <thead class="bg-slate-950 text-slate-400 uppercase text-xs">
                        <tr>
                            <th class="p-4">User Info</th>
                            <th class="p-4">ประเภท</th>
                            <th class="p-4 text-right">ยอดเงิน</th>
                            <th class="p-4 text-right">สุทธิ (หลังหัก Fee)</th>
                            <th class="p-4 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="requestTable" class="divide-y divide-slate-700">
                        </tbody>
                </table>
                <div id="noReq" class="p-8 text-center text-slate-500 hidden">ไม่มีรายการค้าง</div>
            </div>
        </div>

        <div id="tabUsers" class="hidden">
            <h2 class="text-2xl font-bold mb-6"><i class="fas fa-user-cog text-blue-500 mr-2"></i> สมาชิกทั้งหมด</h2>
            <div class="flex gap-4 mb-6">
                <input type="text" id="searchUser" placeholder="ค้นหาด้วยอีเมล..." class="bg-slate-800 border border-slate-700 text-white px-4 py-2 rounded w-full max-w-md focus:outline-none">
                <button onclick="fetchUsers()" class="bg-blue-600 px-4 py-2 rounded">ค้นหา</button>
            </div>
            <div id="userGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </div>
        </div>

        <div id="tabNews" class="hidden">
            <h2 class="text-2xl font-bold mb-6"><i class="fas fa-newspaper text-green-500 mr-2"></i> ประกาศข่าวสาร</h2>
            <div class="bg-slate-800 p-6 rounded-lg max-w-2xl">
                <input type="text" id="newsTitle" placeholder="หัวข้อประกาศ" class="w-full mb-4 bg-slate-900 border border-slate-600 rounded p-3 text-white">
                <textarea id="newsContent" rows="4" placeholder="เนื้อหา..." class="w-full mb-4 bg-slate-900 border border-slate-600 rounded p-3 text-white"></textarea>
                <button onclick="postNews()" class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded font-bold">โพสต์ประกาศ</button>
            </div>
        </div>

    </main>

    <div id="modalAdjust" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-slate-800 p-6 rounded-lg w-full max-w-sm border border-slate-600">
            <h3 class="text-xl font-bold mb-4">ปรับยอดเงิน (Manual)</h3>
            <p class="text-sm text-slate-400 mb-2">User: <span id="adjEmail" class="text-blue-400"></span></p>
            <select id="adjType" class="w-full bg-slate-900 border border-slate-700 rounded p-2 mb-3 text-white">
                <option value="add">เพิ่มเงิน (Credit)</option>
                <option value="deduct">ลดเงิน (Debit)</option>
            </select>
            <input type="number" id="adjAmt" placeholder="จำนวนเงิน" class="w-full bg-slate-900 border border-slate-700 rounded p-2 mb-3 text-white">
            <input type="text" id="adjReason" placeholder="เหตุผล (บังคับ)" class="w-full bg-slate-900 border border-slate-700 rounded p-2 mb-4 text-white">
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('modalAdjust').classList.add('hidden')" class="px-4 py-2 text-slate-400">ยกเลิก</button>
                <button onclick="submitAdjust()" class="bg-blue-600 px-4 py-2 rounded text-white">บันทึก</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, onSnapshot, collection, query, where, orderBy, runTransaction, getDocs, updateDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBNfTBQthLLRbJP9BXZ-UQptFsdU324Mv0",
            authDomain: "fafada-d9899.firebaseapp.com",
            projectId: "fafada-d9899",
            storageBucket: "fafada-d9899.firebasestorage.app",
            messagingSenderId: "484777586908",
            appId: "1:484777586908:web:16a8f0367ad15737364419",
            measurementId: "G-Q73X8Q841W"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            // Check Role
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (!userDoc.exists() || userDoc.data().role !== 'admin') {
                alert("คุณไม่มีสิทธิ์เข้าถึงส่วนนี้");
                window.location.href = 'index.html';
                return;
            }
            currentUser = user;
            document.getElementById('adminEmail').textContent = user.email;
            loadPendingRequests();
        });

        window.handleLogout = () => signOut(auth);

        window.switchTab = (tab) => {
            ['dashboard', 'users', 'news'].forEach(t => {
                document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1)).classList.add('hidden');
                document.getElementById('menu' + (t === 'dashboard' ? 'Dash' : t.charAt(0).toUpperCase() + t.slice(1))).className = "w-full text-left px-4 py-3 rounded text-slate-400 hover:bg-slate-700";
            });
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.remove('hidden');
            const activeBtn = document.getElementById('menu' + (tab === 'dashboard' ? 'Dash' : tab.charAt(0).toUpperCase() + tab.slice(1)));
            activeBtn.className = "w-full text-left px-4 py-3 rounded bg-blue-600 text-white";
            
            if(tab === 'users') fetchUsers();
        };

        // 1. Pending Requests
        function loadPendingRequests() {
            const q = query(collection(db, "transactions"), where("status", "==", "pending"), orderBy("timestamp", "asc"));
            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('requestTable');
                tbody.innerHTML = "";
                if(snapshot.empty) {
                    document.getElementById('noReq').classList.remove('hidden');
                } else {
                    document.getElementById('noReq').classList.add('hidden');
                    snapshot.forEach(d => {
                        const t = d.data();
                        const tr = `
                            <tr class="hover:bg-slate-800 transition">
                                <td class="p-4">
                                    <div class="font-bold text-white">${t.userDisplayName}</div>
                                    <div class="text-xs text-slate-400">${t.email}</div>
                                    <div class="text-xs text-slate-500">${new Date(t.timestamp.seconds*1000).toLocaleString('th-TH')}</div>
                                </td>
                                <td class="p-4"><span class="${t.type==='deposit'?'text-green-400':'text-red-400'} font-bold uppercase">${t.type}</span></td>
                                <td class="p-4 text-right font-mono">${t.amount.toLocaleString()}</td>
                                <td class="p-4 text-right font-mono font-bold text-green-300">${t.netAmount.toLocaleString()}</td>
                                <td class="p-4 text-center">
                                    <button onclick="processTxn('${d.id}', 'approve')" class="bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded text-xs mr-2">อนุมัติ</button>
                                    <button onclick="processTxn('${d.id}', 'reject')" class="bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded text-xs">ปฏิเสธ</button>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += tr;
                    });
                }
            });
        }

        window.processTxn = async (txnId, action) => {
            if(!confirm("ยืนยันการดำเนินการ?")) return;
            try {
                await runTransaction(db, async (t) => {
                    const txnRef = doc(db, "transactions", txnId);
                    const txnDoc = await t.get(txnRef);
                    if(!txnDoc.exists()) throw "ไม่พบรายการ";
                    const data = txnDoc.data();

                    const userRef = doc(db, "users", data.uid);
                    const userDoc = await t.get(userRef);
                    if(!userDoc.exists()) throw "ไม่พบ User";

                    if(action === 'approve') {
                        let newBal = userDoc.data().balance;
                        if(data.type === 'deposit') newBal += data.amount;
                        else {
                            if(newBal < data.amount) throw "ยอดเงิน User ไม่พอ";
                            newBal -= data.amount;
                        }
                        t.update(userRef, { balance: newBal });
                        t.update(txnRef, { status: 'completed', approvedBy: currentUser.email });
                    } else {
                        t.update(txnRef, { status: 'rejected', rejectedBy: currentUser.email });
                    }
                });
                alert("สำเร็จ");
            } catch(e) { alert("Error: " + e); }
        };

        // 2. User Management
        window.fetchUsers = async () => {
            const grid = document.getElementById('userGrid');
            grid.innerHTML = '<div class="text-slate-500">Loading...</div>';
            const term = document.getElementById('searchUser').value;
            let q;
            if(term) q = query(collection(db, "users"), where("email", "==", term));
            else q = query(collection(db, "users"), orderBy("createdAt", "desc"));
            
            const snaps = await getDocs(q);
            grid.innerHTML = "";
            if(snaps.empty) { grid.innerHTML = "ไม่พบข้อมูล"; return; }

            snaps.forEach(d => {
                const u = d.data();
                const card = `
                    <div class="bg-slate-800 p-4 rounded border border-slate-700">
                        <div class="flex justify-between mb-2">
                            <h4 class="font-bold">${u.displayName}</h4>
                            <span class="text-xs bg-slate-700 px-2 py-1 rounded">${u.role}</span>
                        </div>
                        <p class="text-xs text-slate-400 mb-4">${u.email}</p>
                        <div class="text-2xl font-bold text-green-400 mb-4">฿${u.balance.toLocaleString()}</div>
                        <button onclick="openAdjust('${u.uid}', '${u.email}')" class="w-full bg-slate-700 hover:bg-slate-600 py-2 rounded text-sm border border-slate-600">ปรับยอดเงิน</button>
                    </div>
                `;
                grid.innerHTML += card;
            });
        };

        let selectedUser = null;
        window.openAdjust = (uid, email) => {
            selectedUser = uid;
            document.getElementById('adjEmail').textContent = email;
            document.getElementById('modalAdjust').classList.remove('hidden');
        };

        window.submitAdjust = async () => {
            const amt = parseFloat(document.getElementById('adjAmt').value);
            const reason = document.getElementById('adjReason').value;
            const type = document.getElementById('adjType').value;
            if(!amt || !reason) return alert("กรอกข้อมูลให้ครบ");

            try {
                await runTransaction(db, async(t) => {
                    const ref = doc(db, "users", selectedUser);
                    const ud = await t.get(ref);
                    let bal = ud.data().balance;
                    if(type === 'add') bal += amt; else bal -= amt;
                    
                    t.update(ref, { balance: bal });
                    const txnRef = doc(collection(db, "transactions"));
                    t.set(txnRef, {
                        uid: selectedUser,
                        email: ud.data().email,
                        type: 'adjustment',
                        amount: amt,
                        status: 'completed',
                        reason: `Admin Adjusted (${type}): ${reason}`,
                        timestamp: new Date()
                    });
                });
                alert("ปรับยอดเรียบร้อย");
                document.getElementById('modalAdjust').classList.add('hidden');
                fetchUsers();
            } catch(e) { alert(e); }
        };

        // 3. News
        window.postNews = async () => {
            const title = document.getElementById('newsTitle').value;
            const content = document.getElementById('newsContent').value;
            if(!title) return;
            await addDoc(collection(db, "announcements"), { title, content, createdAt: new Date() });
            alert("ประกาศแล้ว");
            document.getElementById('newsTitle').value = "";
            document.getElementById('newsContent').value = "";
        };

    </script>
</body>
</html>
