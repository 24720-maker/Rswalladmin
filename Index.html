<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GOD MODE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>body{background:#0a0a0a;color:#ccc;font-family:'Kanit'} .card{background:#151515;border:1px solid #333;padding:20px;border-radius:12px} input{background:#222;border:1px solid #444;color:fff;padding:8px;border-radius:6px;width:100%}</style>
</head>
<body class="p-6">
    <div id="auth" class="mt-20 text-center">
        <h1 class="text-3xl font-bold text-yellow-500 mb-4">ADMIN</h1>
        <input id="a-pass" type="password" class="w-64 text-center" placeholder="Password">
        <button onclick="Admin.login()" class="bg-yellow-600 text-black font-bold px-6 py-2 rounded mt-2">LOGIN</button>
    </div>

    <div id="panel" class="hidden max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="card">
            <h3 class="font-bold text-white mb-4 border-b border-gray-700 pb-2">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á</h3>
            <div class="space-y-3">
                <input id="r-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á">
                <input id="r-bet" type="number" placeholder="‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô">
                <select id="r-type" class="w-full bg-[#222] text-white p-2 rounded border border-[#444]">
                    <option value="rps">‚úä ‡πÄ‡∏õ‡πà‡∏≤‡∏¢‡∏¥‡πâ‡∏á‡∏â‡∏∏‡∏ö</option>
                    <option value="pokdeng">üé¥ ‡∏õ‡πä‡∏≠‡∏Å‡πÄ‡∏î‡πâ‡∏á</option>
                </select>
                <select id="r-rig" class="w-full bg-[#222] text-white p-2 rounded border border-[#444]">
                    <option value="">-- ‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Ñ‡∏ú‡∏• --</option>
                    <option value="p1">‡πÉ‡∏´‡πâ P1 ‡∏ä‡∏ô‡∏∞</option>
                    <option value="p2">‡πÉ‡∏´‡πâ P2 ‡∏ä‡∏ô‡∏∞</option>
                </select>
                <button onclick="Admin.create()" class="w-full bg-green-600 text-white font-bold py-2 rounded">‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
            </div>
        </div>

        <div class="card md:col-span-2">
            <h3 class="font-bold text-white mb-4 flex justify-between"><span>Live Monitor</span><span class="text-green-500 text-xs animate-pulse">Running</span></h3>
            <div id="room-list" class="grid grid-cols-2 gap-3 max-h-[400px] overflow-y-auto"></div>
        </div>

        <div class="card md:col-span-3">
            <h3 class="font-bold text-white mb-4">‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</h3>
            <div id="tx-list" class="flex gap-4 overflow-x-auto pb-2"></div>
        </div>
        
        <div class="card md:col-span-3">
            <h3 class="font-bold text-white mb-4">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ / ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ü‡∏£‡∏µ</h3>
            <div class="flex gap-4">
                <input id="s-ann" placeholder="‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®">
                <input id="s-link" placeholder="‡∏•‡∏¥‡πâ‡∏á‡∏Å‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠">
                <button onclick="Admin.saveSet()" class="bg-blue-600 px-4 rounded text-white">Save</button>
            </div>
            <div class="flex gap-4 mt-4">
                <input id="c-code" placeholder="CODE">
                <input id="c-amt" placeholder="AMT">
                <button onclick="Admin.createCode()" class="bg-purple-600 px-4 rounded text-white">Gen</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDc50wlOejDQi3PTySiQss3bLuVz_-tvB4", authDomain: "walletrs-d6104.firebaseapp.com", projectId: "walletrs-d6104", storageBucket: "walletrs-d6104.firebasestorage.app", messagingSenderId: "496661515180", appId: "1:496661515180:web:42c3a21541cdfc68cf8809", measurementId: "G-2P8SGLR602", databaseURL: "https://walletrs-d6104-default-rtdb.asia-southeast1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database(), auth = firebase.auth();

        // --- SERVER ENGINE ---
        // Runs logic for 10s countdown, auto-play, and dealing cards
        setInterval(() => {
            db.ref('rooms').once('value', s => {
                s.forEach(doc => {
                    const r = doc.val(), k = doc.key;
                    
                    // 1. Ready Check -> Start Game
                    if(r.status==='waiting_ready' && r.p1.ready && r.p2.ready) {
                        if(r.type === 'rps') db.ref(`rooms/${k}`).update({ status:'playing', turnStartTime:Date.now() });
                        else if(r.type === 'pokdeng') Engine.startPokdeng(k, r);
                    }

                    // 2. RPS Logic
                    if(r.type==='rps' && r.status==='playing') {
                        const elapsed = (Date.now() - r.turnStartTime)/1000;
                        if(elapsed > 10 && (!r.p1.move || !r.p2.move)) {
                            // Auto Move if timeout
                            const m=['rock','paper','scissors'];
                            if(!r.p1.move) db.ref(`rooms/${k}/p1/move`).set(m[Math.floor(Math.random()*3)]);
                            if(!r.p2.move) db.ref(`rooms/${k}/p2/move`).set(m[Math.floor(Math.random()*3)]);
                        }
                        if(r.p1.move && r.p2.move) Engine.resolveRPS(k, r);
                    }

                    // 3. Pokdeng Logic (Simplified)
                    if(r.type==='pokdeng' && r.status==='playing') {
                        // Logic for card dealing, checking actions from `r.actions`
                        // (Implemented in Engine.processPokActions in full version)
                    }
                });
            });
        }, 1000);

        const Engine = {
            resolveRPS: (k, r) => {
                db.ref(`rooms/${k}/status`).set('calculating');
                setTimeout(() => {
                    const m1=r.p1.move, m2=r.p2.move;
                    let w=0; 
                    if(m1!==m2) {
                        if((m1=='rock'&&m2=='scissors')||(m1=='paper'&&m2=='rock')||(m1=='scissors'&&m2=='paper')) w=1; else w=2;
                    }
                    const s1=r.p1.score+(w===1?1:0), s2=r.p2.score+(w===2?1:0);
                    
                    if(r.round < r.maxRound) db.ref(`rooms/${k}`).update({status:'waiting_ready', round:r.round+1, 'p1/move':'', 'p1/ready':false, 'p2/move':'', 'p2/ready':false, 'p1/score':s1, 'p2/score':s2});
                    else Engine.finishGame(k, r, s1>s2?r.p1.uid:(s2>s1?r.p2.uid:'draw'));
                }, 2000);
            },
            startPokdeng: (k, r) => {
                // Deal cards logic here... (Simplified for 400 lines limit)
                // For demo: Immediately finish with random score based on Rig
                let s1=Math.floor(Math.random()*9), s2=Math.floor(Math.random()*9);
                if(r.rig==='p1') {s1=9; s2=2;} if(r.rig==='p2') {s1=3; s2=9;}
                
                db.ref(`rooms/${k}`).update({
                    status:'playing', stage:'deal',
                    'p1/hand':[{rank:'9',suit:'D'},{rank:'K',suit:'S'}], // Mock deal
                    'p2/hand':[{rank:'2',suit:'C'},{rank:'3',suit:'H'}]
                });
                
                setTimeout(() => Engine.finishGame(k, r, s1>s2?r.p1.uid:(s2>s1?r.p2.uid:'draw')), 3000);
            },
            finishGame: (k, r, winner) => {
                db.ref(`rooms/${k}`).update({status:'finished', winner:winner});
                if(winner==='draw') {
                    db.ref('users/'+r.p1.uid+'/balance').transaction(b=>b+r.bet);
                    db.ref('users/'+r.p2.uid+'/balance').transaction(b=>b+r.bet);
                } else {
                    db.ref('users/'+winner+'/balance').transaction(b=>b+r.bet*2);
                }
            }
        };

        const Admin = {
            login: () => { if(document.getElementById('a-pass').value) { document.getElementById('auth').style.display='none'; document.getElementById('panel').style.display='block'; Admin.init(); } },
            init: () => {
                db.ref('rooms').on('value', s => {
                    const l=document.getElementById('room-list'); l.innerHTML='';
                    s.forEach(d => { const r=d.val(); l.innerHTML+=`<div class="bg-[#222] p-2 rounded text-xs border border-gray-700 relative"><b class="text-yellow-500">${r.name}</b><br>State: ${r.status}<br>P1: ${r.p1?.name} | P2: ${r.p2?.name}<button onclick="db.ref('rooms/${d.key}').remove()" class="text-red-500 absolute top-2 right-2">Del</button></div>`; });
                });
                db.ref('transactions').orderByChild('status').equalTo('pending').on('value', s => {
                    const l=document.getElementById('tx-list'); l.innerHTML='';
                    s.forEach(d => { const t=d.val(); l.innerHTML+=`<div class="bg-[#222] p-2 rounded min-w-[200px] border-l-2 border-yellow-500 text-xs"><b>${t.type} ${t.amount}</b><br>${t.name}<br><button onclick="Admin.tx('${d.key}','approved','${t.uid}',${t.amount},'${t.type}')" class="text-green-500 mr-2">OK</button><button onclick="Admin.tx('${d.key}','rejected')" class="text-red-500">NO</button></div>`; });
                });
            },
            create: () => {
                const n=document.getElementById('r-name').value, b=Number(document.getElementById('r-bet').value);
                if(n&&b) db.ref('rooms').push({name:n, bet:b, type:document.getElementById('r-type').value, rig:document.getElementById('r-rig').value, maxRound:3, round:1, status:'open', created:Date.now()});
            },
            tx: (k,s,u,a,t) => {
                db.ref('transactions/'+k).update({status:s});
                if(s=='approved' && t=='deposit') db.ref('users/'+u+'/balance').transaction(b=>b+a);
                if(s=='rejected' && t=='withdraw') db.ref('users/'+u+'/balance').transaction(b=>b+a);
            },
            saveSet: () => db.ref('settings').update({announcement:document.getElementById('s-ann').value, contactLink:document.getElementById('s-link').value}),
            createCode: () => db.ref('codes/'+document.getElementById('c-code').value).set({amount:Number(document.getElementById('c-amt').value), used:false}),
            addBank: () => db.ref('settings/banks').push({name:document.getElementById('b-name').value, acc:document.getElementById('b-acc').value})
        };
    </script>
</body>
</html>
