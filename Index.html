<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITANIUM ADMIN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>body{background:#0f172a;color:#cbd5e1;font-family:'Prompt'} .card{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:20px} input{background:#0f172a;border:1px solid #334155;color:white;padding:10px;width:100%;border-radius:8px;outline:none}</style>
</head>
<body class="p-6">

    <div id="auth" class="flex h-screen items-center justify-center">
        <div class="card w-96 text-center">
            <h1 class="text-2xl font-bold text-emerald-500 mb-6">ADMIN PANEL</h1>
            <input id="a-pass" type="password" class="text-center mb-4" placeholder="รหัสผ่าน">
            <button onclick="Admin.login()" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-lg">เข้าสู่ระบบ</button>
        </div>
    </div>

    <div id="panel" class="hidden max-w-6xl mx-auto">
        <header class="flex justify-between mb-8">
            <h1 class="text-2xl font-bold text-white">DASHBOARD</h1>
            <div class="text-emerald-400">Total Users: <span id="u-count">0</span></div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="card md:col-span-2">
                <h3 class="font-bold text-white mb-4">รายการรออนุมัติ</h3>
                <div id="tx-list" class="space-y-3 max-h-[500px] overflow-y-auto"></div>
            </div>

            <div class="card space-y-6">
                <div>
                    <h3 class="font-bold text-blue-400 mb-2">ตั้งค่าระบบ</h3>
                    <label class="text-xs text-gray-500">ค่าธรรมเนียมถอน (%)</label>
                    <input id="s-fee" type="number" class="text-center font-bold text-yellow-500">
                    <button onclick="Admin.saveFee()" class="w-full bg-blue-600 text-white font-bold py-2 rounded mt-2 text-sm">อัปเดตค่าธรรมเนียม</button>
                </div>
                <div>
                    <h3 class="font-bold text-green-400 mb-2">เพิ่มบัญชีธนาคาร</h3>
                    <div class="flex gap-2 mb-2"><input id="b-name" placeholder="ธนาคาร"><input id="b-acc" placeholder="เลข"></div>
                    <button onclick="Admin.addBank()" class="w-full bg-green-600 text-white font-bold py-2 rounded text-sm">เพิ่มบัญชี</button>
                    <div id="bank-list" class="mt-2 space-y-1 text-xs"></div>
                </div>
            </div>
        </div>
        
        <div class="card mt-6">
            <h3 class="font-bold text-white mb-4">รายชื่อสมาชิก</h3>
            <table class="w-full text-left text-sm text-gray-400">
                <thead><tr class="border-b border-gray-700"><th>ชื่อ</th><th>ยอดเงิน</th><th>บัญชี</th><th>จัดการ</th></tr></thead>
                <tbody id="user-list"></tbody>
            </table>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDc50wlOejDQi3PTySiQss3bLuVz_-tvB4", authDomain: "walletrs-d6104.firebaseapp.com", projectId: "walletrs-d6104", storageBucket: "walletrs-d6104.firebasestorage.app", messagingSenderId: "496661515180", appId: "1:496661515180:web:42c3a21541cdfc68cf8809", measurementId: "G-2P8SGLR602", databaseURL: "https://walletrs-d6104-default-rtdb.asia-southeast1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database(); const auth = firebase.auth();

        const Admin = {
            login: () => auth.signInWithEmailAndPassword('farisxuma1@gmail.com', document.getElementById('a-pass').value).then(()=>{document.getElementById('auth').style.display='none'; document.getElementById('panel').style.display='block'; Admin.init();}).catch(e=>Swal.fire('Error','รหัสผิด','error')),
            init: () => {
                db.ref('transactions').orderByChild('status').equalTo('pending').on('value', s => {
                    const l = document.getElementById('tx-list'); l.innerHTML = '';
                    if(!s.exists()) l.innerHTML = '<p class="text-center text-gray-600">ไม่มีรายการ</p>';
                    s.forEach(d => {
                        const t = d.val();
                        l.innerHTML += `
                            <div class="bg-black/30 p-3 rounded border-l-4 ${t.type=='deposit'?'border-green-500':'border-red-500'} flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-white">${t.type.toUpperCase()} ฿${t.amount.toLocaleString()} ${t.type=='withdraw'?`<span class="text-xs text-yellow-500">(Fee: ${t.fee}, Net: ${t.net_amount})</span>`:''}</div>
                                    <div class="text-xs text-gray-400">${t.name} • ${t.time||''} • ${t.bank_info||''}</div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="Admin.tx('${d.key}','approved','${t.uid}',${t.amount},'${t.type}')" class="bg-green-600 px-3 py-1 rounded text-white text-xs">อนุมัติ</button>
                                    <button onclick="Admin.tx('${d.key}','rejected','${t.uid}',${t.amount},'${t.type}')" class="bg-red-600 px-3 py-1 rounded text-white text-xs">ปฏิเสธ</button>
                                </div>
                            </div>`;
                    });
                });
                db.ref('users').on('value', s => {
                    const l=document.getElementById('user-list'); l.innerHTML=''; document.getElementById('u-count').innerText=s.numChildren();
                    s.forEach(d => { const u=d.val(); l.innerHTML+=`<tr class="border-b border-gray-700/50"><td class="p-3 text-white">${u.name}</td><td class="text-emerald-400">฿${(u.balance||0).toLocaleString()}</td><td>${u.bank} ${u.acc}</td><td><button onclick="Admin.adj('${d.key}',${u.balance})" class="text-blue-400">แก้ไขเงิน</button></td></tr>`; });
                });
                db.ref('settings').on('value', s => {
                    const c = s.val() || {};
                    document.getElementById('s-fee').value = c.fee || 0;
                    const bl = document.getElementById('bank-list'); bl.innerHTML='';
                    if(c.banks) Object.entries(c.banks).forEach(([k,v]) => bl.innerHTML+=`<div class="flex justify-between bg-black/30 p-1 px-2 rounded mb-1"><span>${v.name}-${v.acc}</span><span onclick="db.ref('settings/banks/${k}').remove()" class="text-red-500 cursor-pointer">x</span></div>`);
                });
            },
            tx: (k, st, uid, amt, type) => {
                db.ref('transactions/'+k).update({status:st});
                if(st=='approved' && type=='deposit') db.ref('users/'+uid+'/balance').transaction(b=>(b||0)+amt);
                if(st=='rejected' && type=='withdraw') db.ref('users/'+uid+'/balance').transaction(b=>(b||0)+amt); // Refund full amount
            },
            saveFee: () => db.ref('settings/fee').set(Number(document.getElementById('s-fee').value)).then(()=>Swal.fire('Saved')),
            addBank: () => db.ref('settings/banks').push({name:document.getElementById('b-name').value, acc:document.getElementById('b-acc').value}),
            adj: async (uid, old) => { const {value:n}=await Swal.fire({title:'ปรับเงิน',input:'number',inputValue:old}); if(n) db.ref('users/'+uid).update({balance:Number(n)}); }
        };
    </script>
</body>
</html>
