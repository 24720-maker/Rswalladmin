<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RS COMMAND CENTER | ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@100;200;300;400;500;600&family=Prompt:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Kanit', 'sans-serif'], title: ['Prompt', 'sans-serif'] },
                    colors: { brand: '#F0B90B', cyber: '#0052FF', bgDark: '#010409', cardDark: '#0D1117', success: '#00C076', danger: '#FF3B30' }
                }
            }
        }
    </script>

    <style>
        :root { --brand: #F0B90B; }
        body { background-color: #010409; color: #E6EDF3; font-family: 'Kanit', sans-serif; overflow-x: hidden; }
        .admin-sidebar { background: #0D1117; border-right: 1px solid #30363d; height: 100vh; position: sticky; top: 0; }
        .stat-card { background: #0D1117; border: 1px solid #30363d; border-radius: 1.5rem; transition: 0.3s; }
        .stat-card:hover { transform: translateY(-5px); border-color: var(--brand); }
        .user-row:hover { background: rgba(255,255,255,0.02); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex min-h-screen">

    <div id="loader" class="fixed inset-0 z-[1000] bg-bgDark flex flex-col items-center justify-center transition-all duration-700">
        <div class="w-16 h-16 border-4 border-brand/20 border-t-brand rounded-full animate-spin mb-6"></div>
        <p class="text-brand font-black tracking-[0.3em] text-xs uppercase animate-pulse">Authenticating Admin Access...</p>
    </div>

    <div id="authPage" class="hidden fixed inset-0 z-[900] bg-bgDark flex items-center justify-center p-6">
        <div class="luxury-card max-w-sm w-full p-10 bg-cardDark rounded-[3rem] text-center shadow-2xl border border-brand/20">
            <div class="w-20 h-20 bg-brand rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-2xl">
                <i class="fas fa-user-shield text-bgDark text-3xl"></i>
            </div>
            <h1 class="text-3xl font-black text-white italic font-title uppercase mb-2">Admin <span class="text-brand">Login</span></h1>
            <p class="text-slate-500 text-[10px] font-bold uppercase mb-10 tracking-widest">RS NEURAL COMMAND CENTER</p>
            <div class="space-y-4">
                <input id="lEmail" type="email" class="w-full p-5 bg-bgDark border border-slate-800 rounded-2xl text-white outline-none focus:border-brand" placeholder="Admin E-mail">
                <input id="lPass" type="password" class="w-full p-5 bg-bgDark border border-slate-800 rounded-2xl text-white outline-none focus:border-brand" placeholder="Master Key">
                <button onclick="admin.login()" class="w-full bg-brand text-bgDark py-5 rounded-2xl font-black uppercase text-xs shadow-xl hover:scale-105 transition-all">Unlock System</button>
            </div>
        </div>
    </div>

    <aside class="admin-sidebar w-72 p-8 hidden lg:flex flex-col">
        <div class="flex items-center gap-3 mb-12">
            <div class="w-10 h-10 bg-brand rounded-xl flex items-center justify-center text-bgDark font-black italic">RS</div>
            <h2 class="text-white font-black text-lg font-title tracking-tighter">RS COMMAND</h2>
        </div>
        
        <nav class="space-y-2 flex-1">
            <div onclick="ui.view('dash')" id="n-dash" class="p-4 rounded-xl text-brand font-bold flex items-center gap-4 cursor-pointer bg-brand/10 border border-brand/20 transition-all"><i class="fas fa-chart-pie w-5"></i> ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏´‡∏•‡∏±‡∏Å</div>
            <div onclick="ui.view('users')" id="n-users" class="p-4 rounded-xl text-slate-400 font-bold flex items-center gap-4 cursor-pointer hover:bg-white/5 transition-all"><i class="fas fa-users w-5"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>
            <div onclick="ui.view('logs')" id="n-logs" class="p-4 rounded-xl text-slate-400 font-bold flex items-center gap-4 cursor-pointer hover:bg-white/5 transition-all"><i class="fas fa-satellite-dish w-5"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î</div>
        </nav>

        <button onclick="admin.logout()" class="text-rose-500 font-bold text-xs p-4 border border-rose-500/20 rounded-xl hover:bg-rose-500 hover:text-white transition-all"><i class="fas fa-power-off mr-3"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </aside>

    <main class="flex-1 p-8 lg:p-14 overflow-y-auto no-scrollbar hidden" id="mainDashboard">
        
        <section id="v-dash" class="space-y-12 fade-in">
            <header>
                <h1 class="text-4xl font-black text-white font-title italic uppercase">System <span class="text-brand">Analytics</span></h1>
                <p class="text-slate-500 font-bold text-xs uppercase tracking-widest mt-2">‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="stat-card p-8"><p class="text-[10px] font-black text-slate-500 uppercase mb-4 tracking-widest">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p><h3 id="statTotal" class="text-5xl font-black italic text-white font-title">0</h3></div>
                <div class="stat-card p-8 border-l-4 border-l-success"><p class="text-[10px] font-black text-slate-500 uppercase mb-4 tracking-widest">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Active)</p><h3 id="statActive" class="text-5xl font-black italic text-success font-title">0</h3></div>
                <div class="stat-card p-8 border-l-4 border-l-danger"><p class="text-[10px] font-black text-slate-500 uppercase mb-4 tracking-widest">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (Expired)</p><h3 id="statExpired" class="text-5xl font-black italic text-danger font-title">0</h3></div>
            </div>

            <div class="bg-cardDark border border-slate-800 rounded-3xl p-10 space-y-6">
                <h3 class="font-black text-white text-xl font-title uppercase italic border-l-4 border-brand pl-5">Recent Subscriptions</h3>
                <div id="recentSubs" class="space-y-4">
                    </div>
            </div>
        </section>

        <section id="v-users" class="hidden space-y-10 fade-in">
            <header class="flex flex-col md:flex-row justify-between items-end gap-6">
                <div>
                    <h1 class="text-4xl font-black text-white font-title italic uppercase">User <span class="text-brand">Master</span></h1>
                    <p class="text-slate-500 font-bold text-xs uppercase tracking-widest mt-2">‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</p>
                </div>
                <div class="relative w-full md:w-80">
                    <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-500"></i>
                    <input id="userSearch" oninput="ui.searchUsers(this.value)" class="w-full pl-12 pr-6 py-4 bg-cardDark border border-slate-800 rounded-2xl text-sm font-bold text-white focus:border-brand" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏≠‡∏µ‡πÄ‡∏°‡∏•...">
                </div>
            </header>

            <div class="overflow-x-auto luxury-card border-slate-800">
                <table class="w-full text-left">
                    <thead class="bg-bgDark/50 text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] border-b border-slate-800">
                        <tr>
                            <th class="p-8">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
                            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞/‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
                            <th class="text-center p-8">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (Subscription)</th>
                        </tr>
                    </thead>
                    <tbody id="userTable"></tbody>
                </table>
            </div>
        </section>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // üî• FIREBASE CONFIG (Required)
        const firebaseConfig = { apiKey: "AIzaSyBNfTBQthLLRbJP9BXZ-UQptFsdU324Mv0", authDomain: "fafada-d9899.firebaseapp.com", projectId: "fafada-d9899", storageBucket: "fafada-d9899.firebasestorage.app", messagingSenderId: "484777586908", appId: "1:484777586908:web:16a8f0367ad15737364419" };
        const app_fb = initializeApp(firebaseConfig);
        const auth = getAuth(app_fb);
        const db = getFirestore(app_fb);

        let allUsers = [];

        window.ui = {
            view: (v) => {
                document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
                document.getElementById('v-'+v).classList.remove('hidden');
                document.querySelectorAll('.admin-sidebar nav div').forEach(n => {
                    n.classList.remove('bg-brand/10', 'text-brand', 'border-brand/20');
                    n.classList.add('text-slate-400');
                });
                document.getElementById('n-'+v).classList.add('bg-brand/10', 'text-brand', 'border-brand/20');
                document.getElementById('n-'+v).classList.remove('text-slate-400');
            },
            hideLoader: () => { document.getElementById('loader').classList.add('opacity-0'); setTimeout(()=> document.getElementById('loader').classList.add('hidden'), 700); },
            searchUsers: (val) => {
                const filtered = allUsers.filter(u => u.displayName.toLowerCase().includes(val.toLowerCase()) || u.email.toLowerCase().includes(val.toLowerCase()));
                ui.renderTable(filtered);
            },
            renderTable: (list) => {
                const tb = document.getElementById('userTable'); tb.innerHTML = '';
                const now = new Date();
                list.forEach(u => {
                    const expiry = u.expiryDate ? new Date(u.expiryDate.seconds * 1000) : null;
                    const isActive = expiry && expiry > now;
                    const statusClass = isActive ? 'text-success' : 'text-danger';
                    const statusText = isActive ? `Active (‡∏ñ‡∏∂‡∏á ${moment(expiry).format('DD/MM/YY HH:mm')})` : (u.subType === 'none' ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£' : '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß');

                    tb.innerHTML += `
                    <tr class="user-row border-b border-slate-800/50 transition-all">
                        <td class="p-8">
                            <div class="flex items-center gap-4">
                                <div class="w-11 h-11 rounded-full bg-slate-800 flex items-center justify-center font-black text-xs">${u.displayName.charAt(0)}</div>
                                <div><p class="font-black text-white leading-none">${u.displayName}</p><p class="text-[10px] text-slate-500 mt-1">${u.email}</p></div>
                            </div>
                        </td>
                        <td class="text-xs font-black uppercase text-brand">${u.subType || 'None'}</td>
                        <td class="text-[11px] font-bold ${statusClass}">${statusText}</td>
                        <td class="p-8 text-center">
                            <div class="flex justify-center gap-2">
                                <button onclick="admin.updateSub('${u.id}', 1, 'daily')" class="px-4 py-2 bg-slate-800 text-[9px] font-black uppercase rounded-lg hover:bg-brand hover:text-bgDark transition-all">1 ‡∏ß‡∏±‡∏ô</button>
                                <button onclick="admin.updateSub('${u.id}', 30, 'monthly')" class="px-4 py-2 bg-slate-800 text-[9px] font-black uppercase rounded-lg hover:bg-cyber hover:text-white transition-all">30 ‡∏ß‡∏±‡∏ô</button>
                                <button onclick="admin.updateSub('${u.id}', 365, 'yearly')" class="px-4 py-2 bg-brand text-bgDark text-[9px] font-black uppercase rounded-lg shadow-lg">1 ‡∏õ‡∏µ</button>
                            </div>
                        </td>
                    </tr>`;
                });
            }
        };

        window.admin = {
            login: async () => {
                const em = document.getElementById('lEmail').value.trim();
                const ps = document.getElementById('lPass').value.trim();
                if(em !== 'farisxuma1@gmail.com') return Swal.fire('Denied', 'Unauthorized Email', 'error');
                try { await signInWithEmailAndPassword(auth, em, ps); } catch(e) { Swal.fire('Error', 'Master Key Incorrect', 'error'); }
            },
            logout: () => signOut(auth).then(()=>location.reload()),
            updateSub: async (uid, days, planName) => {
                Swal.showLoading();
                const newExpiry = new Date();
                newExpiry.setDate(newExpiry.getDate() + days);
                
                await updateDoc(doc(db, "users", uid), {
                    subType: planName,
                    expiryDate: newExpiry
                });
                
                Swal.fire({ icon: 'success', title: 'Updated!', text: `‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ß‡∏•‡∏≤ ${planName} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, timer: 1500, showConfirmButton: false });
            }
        };

        // üîó Real-time Data Nexus
        onAuthStateChanged(auth, u => {
            if(u && u.email === 'farisxuma1@gmail.com') {
                document.getElementById('authPage').classList.add('hidden');
                document.getElementById('mainDashboard').classList.remove('hidden');
                ui.hideLoader();

                // Listen to all users
                onSnapshot(collection(db, "users"), s => {
                    allUsers = s.docs.map(d => ({id: d.id, ...d.data()}));
                    const now = new Date();
                    const activeCount = allUsers.filter(u => u.expiryDate && new Date(u.expiryDate.seconds*1000) > now).length;
                    
                    document.getElementById('statTotal').innerText = allUsers.length;
                    document.getElementById('statActive').innerText = activeCount;
                    document.getElementById('statExpired').innerText = allUsers.length - activeCount;
                    
                    ui.renderTable(allUsers);
                });

            } else {
                document.getElementById('authPage').classList.remove('hidden');
                ui.hideLoader();
            }
        });
    </script>
</body>
</html>
